<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apex Test Results</title>

  <!-- Tailwind (class-based dark mode) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {} }
    }
  </script>
  <link rel="icon" type="image/x-icon"
        href="https://mohan-chinnappan-n5.github.io/dfv/img/mc_favIcon.ico" />

  <!-- DataTables CSS + Buttons -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .dt-topbar { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .kpi { min-height:72px; }

    /* Dark-mode overrides for DataTables */
    .dark .dataTables_wrapper, .dark table.dataTable {
      --dt-bg: #0f172a;
      --dt-foreground: #e6eef8;
      --dt-border: #1f2937;
      background: var(--dt-bg);
      color: var(--dt-foreground);
    }
    .dark table.dataTable thead th {
      background: #0b1220;
      color: var(--dt-foreground);
      border-bottom: 1px solid var(--dt-border);
    }
    .dark table.dataTable tbody td {
      border-bottom: 1px dashed var(--dt-border);
      color: var(--dt-foreground);
    }
    .dark .dt-button, .dark .dt-button:active, .dark .dt-button:focus {
      background: #0f172a;
      color: #e6eef8;
      border: 1px solid #334155;
    }
    .dark table.dataTable tbody tr.bg-green-50 {
      background: rgba(16,185,129,0.08);
    }
    .dark table.dataTable tbody tr.bg-red-50 {
      background: rgba(239,68,68,0.08);
    }
  </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 transition-colors">

  <div class="max-w-7xl mx-auto p-6">
    <header class="flex items-start justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl font-bold">üß™ Apex Test Results ‚Äî Viewer </h1>
        <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">Upload your Salesforce test result JSON.</p>
        <p class="text-xs text-slate-500 dark:text-slate-500 mt-1">
          To get test results JSON, run: <code class="bg-slate-200 dark:bg-slate-800 px-2 py-0.5 rounded">sf apex run test -o username -w 30 -r json > output.json</code>
        </p>
      </div>

      <div class="flex items-center gap-3">
        <div class="text-xs text-slate-500 dark:text-slate-400 mr-2">Theme</div>
        <button id="themeToggle" class="px-3 py-2 rounded-md bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
          <span class="dark:hidden">üåô Dark</span>
          <span class="hidden dark:inline">‚òÄÔ∏è Light</span>
        </button>
      </div>
    </header>

    <!-- KPIs Section (Top) -->
    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm mb-6">
      <h3 class="text-sm font-semibold mb-4">Test Summary KPIs</h3>
      <div id="kpiContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
        <!-- KPI cards rendered here -->
      </div>
    </div>

    <!-- Quick Lists Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm">
        <h4 class="text-sm font-semibold mb-3">‚è±Ô∏è Top Slowest Tests</h4>
        <ul id="slowList" class="space-y-2 text-sm"></ul>
      </div>

      <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm">
        <h4 class="text-sm font-semibold mb-3">‚ùå Failing Tests</h4>
        <ul id="failList" class="space-y-2 text-sm"></ul>
      </div>
    </div>

    <!-- DataTable Section -->
    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm mb-6">
      <div class="flex items-center justify-between dt-topbar">
        <div>
          <label class="inline-flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
            <span class="text-sm font-medium">Upload JSON</span>
            <input id="jsonFile" type="file" accept=".json,application/json" class="hidden">
          </label>
          <span id="runInfo" class="ml-4 text-xs text-slate-500 dark:text-slate-400"></span>
        </div>

        <div class="flex items-center gap-2">
          <button id="loadSample" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-sm transition-colors">Load Sample</button>
          <button id="clearBtn" class="px-3 py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600 rounded-md text-sm transition-colors">Clear</button>
        </div>
      </div>

      <div class="mt-4">
        <table id="testTable" class="stripe hover" style="width:100%">
          <thead>
            <tr>
              <th>#</th>
              <th>Class Name</th>
              <th>Method</th>
              <th>Full Name</th>
              <th>Outcome</th>
              <th>Run Time (ms)</th>
              <th>Message / StackTrace</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <footer class="text-xs text-slate-500 dark:text-slate-400 mt-6">All processing happens in your browser. No data is sent to any server.</footer>
  </div>

  <!-- jQuery & DataTables + Buttons -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    // --- Theme toggle (persisted) ---
    const themeToggle = document.getElementById('themeToggle');
    
    function setTheme(theme) {
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      localStorage.setItem('apex-theme', theme);
    }
    
    // Initialize theme on page load
    (function initTheme() {
      const saved = localStorage.getItem('apex-theme');
      if (saved) {
        setTheme(saved);
      } else {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        setTheme(prefersDark ? 'dark' : 'light');
      }
    })();
    
    // Toggle theme on button click
    themeToggle.addEventListener('click', () => {
      const isDark = document.documentElement.classList.contains('dark');
      setTheme(isDark ? 'light' : 'dark');
    });

    // --- DataTables setup ---
    let dt = null;
    const tableEl = $('#testTable');

    function initDataTable() {
      if (dt) dt.destroy();
      dt = tableEl.DataTable({
        data: [],
        columns: [
          { data: 'index', title: '#', width: '40px' },
          { data: 'className', title: 'Class Name' },
          { data: 'methodName', title: 'Method' },
          { data: 'fullName', title: 'Full Name', visible: false },
          { data: 'outcome', title: 'Outcome' },
          { data: 'runTime', title: 'Run Time (ms)', className: 'dt-right' },
          { data: 'message', title: 'Message / StackTrace' }
        ],
        order: [[5, 'desc']],
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        responsive: true,
        dom: 'Bfrtip',
        buttons: [
          {
            extend: 'csvHtml5',
            text: '‚¨áÔ∏è Export CSV',
            bom: true,
            filename: function() {
              const runId = currentSummary?.testRunId || 'apex-test-results';
              return runId + '-tests';
            },
            exportOptions: { columns: ':visible' }
          }
        ],
        createdRow: function(row, data) {
          const out = (data.outcome || '').toLowerCase();
          if (out === 'pass') $(row).addClass('bg-green-50');
          else if (out === 'fail') $(row).addClass('bg-red-50');
        },
        language: {
          search: "_INPUT_",
          searchPlaceholder: "Search tests (class, method, message...)"
        },
        columnDefs: [
          { targets: 0, orderable: false }
        ]
      });
    }

    initDataTable();

    // --- Helpers & state ---
    let currentTests = [];
    let currentSummary = null;

    function normalizeTest(t, idx) {
      const className =
        (t.ApexClass && (t.ApexClass.Name || t.ApexClass.name)) ||
        t.ApexClassName ||
        t.className ||
        (t.FullName ? (t.FullName.split('.')[0] || '') : '') ||
        '';

      const methodName = t.MethodName || t.methodName || (t.FullName ? (t.FullName.split('.').slice(1).join('.') || '') : '');
      const outcome = t.Outcome || t.outcome || '';
      const runTime = Number(t.RunTime ?? t.runTime ?? t['RunTime(ms)'] ?? t['RunTime'] ?? t.runtime ?? 0) || 0;
      const message = String(t.Message ?? t.message ?? '') + (t.StackTrace ? ('\n' + t.StackTrace) : '');

      return {
        index: idx + 1,
        className,
        methodName,
        fullName: t.FullName || '',
        outcome,
        runTime,
        message
      };
    }

    function computeKpis(summary, tests) {
      const total =
        summary.testsRan ??
        summary.total ??
        summary.numTestsRun ??
        tests.length;

      const passing =
        summary.passing ??
        summary.passed ??
        summary.numPassing ??
        tests.filter(t => (t.Outcome || t.outcome || '').toLowerCase() === 'pass').length;

      const failing =
        summary.failing ??
        summary.failed ??
        summary.numFailures ??
        tests.filter(t => (t.Outcome || t.outcome || '').toLowerCase() === 'fail').length;

      let passRate = summary.passRate || summary.passrate || summary.pass_percentage;
      if (!passRate) passRate = total > 0 ? ((passing / total) * 100).toFixed(2) + '%' : '0%';

      return { total, passing, failing, passRate };
    }

    function renderKPIs(summaryObj, tests) {
      const kpiEl = document.getElementById('kpiContainer');
      kpiEl.innerHTML = '';
      const k = computeKpis(summaryObj || {}, tests || []);
      currentSummary = summaryObj || {};

      function card(title, value, hint = '', icon = '') {
        const d = document.createElement('div');
        d.className = 'kpi bg-slate-50 dark:bg-slate-900/60 rounded-lg p-4 border border-slate-200 dark:border-slate-700';
        d.innerHTML = `
          <div class="text-xs text-slate-500 dark:text-slate-400 mb-1">${icon} ${title}</div>
          <div class="text-2xl font-bold">${value}</div>
          ${hint ? `<div class="text-xs text-slate-400 mt-1 truncate">${hint}</div>` : ''}
        `;
        return d;
      }

      kpiEl.appendChild(card('Total Tests', k.total, '', 'üìã'));
      kpiEl.appendChild(card('Passed', k.passing, '', '‚úÖ'));
      kpiEl.appendChild(card('Failed', k.failing, '', '‚ùå'));
      kpiEl.appendChild(card('Pass Rate', k.passRate, '', 'üìä'));
      
      if (summaryObj?.testRunId) {
        kpiEl.appendChild(card('Test Run', summaryObj.testRunId.substring(0, 15) + '...', summaryObj.hostname || '', 'üî¨'));
      } else if (summaryObj?.testExecutionTime) {
        kpiEl.appendChild(card('Exec Time', summaryObj.testExecutionTime, '', '‚è±Ô∏è'));
      }
    }

    function renderLists(tests) {
      const slowList = document.getElementById('slowList');
      slowList.innerHTML = '';
      const topSlow = [...tests].sort((a,b) => (b.RunTime||b.runTime||0) - (a.RunTime||a.runTime||0)).slice(0,6);
      
      if (topSlow.length === 0) {
        slowList.innerHTML = '<li class="text-slate-500 dark:text-slate-400">No tests loaded</li>';
      } else {
        topSlow.forEach(t => {
          const name = (t.ApexClass && (t.ApexClass.Name || t.ApexClass.name)) || t.ApexClassName || t.className || '';
          const li = document.createElement('li');
          li.className = 'text-slate-700 dark:text-slate-300';
          li.textContent = `${name || t.FullName || '‚Äî'} ‚Äî ${t.RunTime ?? t.runTime ?? 0} ms`;
          slowList.appendChild(li);
        });
      }

      const failList = document.getElementById('failList');
      failList.innerHTML = '';
      const fails = tests.filter(t => ((t.Outcome||t.outcome||'').toLowerCase() === 'fail')).slice(0,8);
      
      if (fails.length === 0) {
        failList.innerHTML = '<li class="text-slate-500 dark:text-slate-400">No failing tests</li>';
      } else {
        fails.forEach(t => {
          const li = document.createElement('li');
          const name = (t.ApexClass && (t.ApexClass.Name || t.ApexClass.name)) || t.ApexClassName || t.className || '';
          const msg = (t.Message || t.message || '').split('\n')[0] || '';
          li.innerHTML = `<div class="font-medium text-slate-700 dark:text-slate-300">${name || t.FullName || ''}</div><div class="text-xs text-slate-500 dark:text-slate-400">${msg}</div>`;
          failList.appendChild(li);
        });
      }
    }

    // --- File handling ---
    document.getElementById('jsonFile').addEventListener('change', async (ev) => {
      const f = ev.target.files[0];
      if (!f) return;
      try {
        const txt = await f.text();
        const json = JSON.parse(txt);
        onLoadJson(json);
      } catch (err) {
        alert('Invalid JSON: ' + err.message);
      }
    });

    document.getElementById('loadSample').addEventListener('click', () => {
      const sample = {
        "status": 100,
        "result": {
          "summary": {
            "failRate": "8%",
            "failing": 4,
            "hostname": "https://dhs000000qasyma4-dev-ed.develop.my.salesforce.com",
            "orgId": "00DHs000000QASYMA4",
            "outcome": "Failed",
            "passRate": "92%",
            "passing": 44,
            "skipped": 0,
            "testRunId": "707Hs0000Lu5ZDQ",
            "testStartTime": "2025-10-07T15:54:54.000Z",
            "testsRan": 48,
            "userId": "005Hs00000BkK19IAF",
            "username": "mohan.chinnappan.n.ea10@gmail.com",
            "commandTime": "114 ms",
            "testExecutionTime": "159714 ms",
            "testTotalTime": "159714 ms"
          },
          "tests": [
            {
              "Id": "07MHs00000HVKahMAH",
              "MethodName": "testSiteLoginController",
              "Outcome": "Pass",
              "ApexClass": { "Id": "01pHs00000LlVm1IAF", "Name": "SiteLoginControllerTest" },
              "RunTime": 8,
              "FullName": "SiteLoginControllerTest.testSiteLoginController"
            },
            {
              "Id": "07MHs00000HVKa8MAH",
              "MethodName": "testQueueable",
              "Outcome": "Fail",
              "ApexClass": { "Id": "01pHs000007R6YPIA0", "Name": "DataManager_QuotaTest" },
              "RunTime": 63,
              "Message": "System.AssertException: Assertion Failed: Expected: 248, Actual: 261",
              "StackTrace": "Class.DataManager_QuotaTest.testQueueable: line 14, column 1",
              "FullName": "DataManager_QuotaTest.testQueueable"
            },
            {
              "Id": "07MHs00000HVKa9MAH",
              "MethodName": "testBatchable",
              "Outcome": "Pass",
              "ApexClass": { "Id": "01pHs000007R6YPIA0", "Name": "DataManager_QuotaTest" },
              "RunTime": 1245,
              "FullName": "DataManager_QuotaTest.testBatchable"
            },
            {
              "Id": "07MHs00000HVKaAMAX",
              "MethodName": "testSchedulable",
              "Outcome": "Pass",
              "ApexClass": { "Id": "01pHs000007R6YPIA0", "Name": "DataManager_QuotaTest" },
              "RunTime": 892,
              "FullName": "DataManager_QuotaTest.testSchedulable"
            }
          ]
        }
      };
      onLoadJson(sample);
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      currentTests = [];
      currentSummary = null;
      renderKPIs({}, []);
      renderLists([]);
      if (dt) {
        dt.clear().draw();
      }
      document.getElementById('runInfo').textContent = '';
    });

    function onLoadJson(json) {
      const result = json.result || json;
      const summary = result.summary || json.summary || {};
      const tests = result.tests || json.tests || [];

      currentTests = tests;
      currentSummary = summary;

      const rows = tests.map((t, idx) => normalizeTest(t, idx));

      const runInfo = document.getElementById('runInfo');
      runInfo.textContent = summary.testRunId ? `Run: ${summary.testRunId}` : (summary.testsRan ? `Tests: ${summary.testsRan}` : '');

      renderKPIs(summary, tests);
      renderLists(tests);

      dt.clear();
      dt.rows.add(rows);
      dt.draw();
    }
  </script>
</body>
</html>
