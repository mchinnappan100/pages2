<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOQL Query Library</title>
  <link rel="icon" type="image/x-icon" href="https://mohan-chinnappan-n5.github.io/dfv/img/mc_favIcon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <style>
    .split-container { display: flex; height: calc(100vh - 80px); }
    .resizer { width: 4px; cursor: col-resize; background: #374151; transition: background 0.2s; }
    .resizer:hover { background: #6366f1; }
    .category-item { cursor: pointer; transition: all 0.2s; }
    .category-item:hover { background: rgba(99, 102, 241, 0.1); }
    .category-item.active { background: rgba(99, 102, 241, 0.2); border-left: 3px solid #6366f1; }
    .query-item { cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
    .query-item:hover { background: rgba(99, 102, 241, 0.1); }
    .query-item.active { background: rgba(99, 102, 241, 0.2); border-left-color: #6366f1; }
    #monacoEditor { height: calc(100vh - 200px); }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 shadow-sm">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-5">
        <i class="fas fa-database text-3xl text-indigo-500"></i>
        <h1 class="text-2xl font-bold">SOQL Query Library</h1>

        <!-- Dataset Selector -->
        <select id="datasetSelector" class="px-5 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
          <option value="q1.json">Standard</option>
          <option value="tooling.json">Tooling API</option>
          <option value="pcm.json">PCM / CPQ</option>
          <option value="dro.json">DRO / Fulfillment</option>
        </select>
      </div>

      <div class="flex items-center gap-3">
        <button id="themeToggle" class="p-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          <i class="fas fa-moon text-xl"></i>
        </button>
        <button id="addCategoryBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded-lg flex items-center gap-2 transition">
          <i class="fas fa-folder-plus"></i> Add Category
        </button>
        <button id="addQueryBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-lg flex items-center gap-2 transition">
          <i class="fas fa-plus"></i> Add Query
        </button>
        <button id="saveBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg flex items-center gap-2 transition">
          <i class="fas fa-save"></i> Save
        </button>
      </div>
    </div>
  </header>

  <div class="split-container">
    <!-- Left Pane -->
    <div id="leftPane" class="bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 overflow-y-auto" style="flex: 0 0 30%;">
      <div class="p-4">
        <input
          type="text"
          id="searchInput"
          placeholder="Search categories and queries..."
          class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none transition"
        />
      </div>
      <div id="categoriesList" class="px-2"></div>
    </div>

    <div id="resizer" class="resizer"></div>

    <!-- Right Pane -->
    <div id="rightPane" class="flex-1 bg-white dark:bg-gray-800 overflow-hidden">
      <div id="emptyState" class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400">
        <div class="text-center">
          <i class="fas fa-arrow-left text-6xl mb-4 opacity-50"></i>
          <p class="text-xl">Select a query to view</p>
        </div>
      </div>

      <div id="queryView" class="hidden h-full flex flex-col">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h2 id="queryTitle" class="text-2xl font-bold mb-2"></h2>
              <p id="queryDescription" class="text-gray-600 dark:text-gray-400"></p>
            </div>
            <div class="flex gap-2">
              <button id="copyBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                <i class="fas fa-copy"></i> Copy
              </button>
              <button id="editQueryBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button id="deleteQueryBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
        <div class="flex-1 p-6">
          <div id="monacoEditor"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Category Modal -->
  <div id="categoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 shadow-xl">
      <h3 class="text-xl font-bold mb-4">Add Category</h3>
      <input type="text" id="categoryNameInput" placeholder="Category Name" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
      <div class="flex gap-3 justify-end">
        <button id="cancelCategoryBtn" class="px-5 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition">Cancel</button>
        <button id="saveCategoryBtn" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Add</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Query Modal -->
  <div id="queryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-[850px] max-w-95vw m-4 shadow-2xl">
      <h3 class="text-xl font-bold mb-5" id="queryModalTitle">Add Query</h3>
      <div class="space-y-5">
        <div>
          <label class="block text-sm font-medium mb-1.5">Category</label>
          <select id="queryCategorySelect" class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none"></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5">Query Name</label>
          <input type="text" id="queryNameInput" placeholder="e.g., Active Accounts with Contacts" class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5">Description</label>
          <textarea id="queryDescInput" rows="2" placeholder="Brief description..." class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none resize-none"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5">SOQL Query</label>
          <textarea id="queryCodeInput" rows="10" placeholder="SELECT Id, Name FROM Account..." class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 font-mono text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
        </div>
      </div>
      <div class="flex gap-3 justify-end mt-8">
        <button id="cancelQueryBtn" class="px-5 py-2.5 bg-gray-300 dark:bg-gray-600 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition">Cancel</button>
        <button id="saveQueryBtn" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Core state
    let queriesData = {};
    let monacoEditor;
    let currentQuery = null;
    let currentCategory = null;
    let editingQueryIndex = -1;
    let searchTerm = '';

    // Dataset mapping
    const DATASETS = {
      "q1.json": "Standard",
      "tooling.json": "Tooling API",
      "pcm.json": "PCM / CPQ",
      "dro.json": "DRO / Fulfillment"
    };

    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    const html = document.documentElement;
    themeToggle.addEventListener('click', () => {
      html.classList.toggle('dark');
      themeToggle.innerHTML = html.classList.contains('dark')
        ? '<i class="fas fa-moon text-xl"></i>'
        : '<i class="fas fa-sun text-xl"></i>';
      if (monacoEditor) monaco.editor.setTheme(html.classList.contains('dark') ? 'vs-dark' : 'vs');
    });

    // Monaco Editor
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
    require(['vs/editor/editor.main'], () => {
      monacoEditor = monaco.editor.create(document.getElementById('monacoEditor'), {
        value: '-- Select a query from the left panel',
        language: 'sql',
        theme: html.classList.contains('dark') ? 'vs-dark' : 'vs',
        automaticLayout: true,
        readOnly: true,
        fontSize: 14,
        minimap: { enabled: false },
        lineNumbers: 'on',
        scrollBeyondLastLine: false,
        wordWrap: 'on'
      });
    });

    // Load queries from URL
    function loadQueries(fileUrl) {
      fetch(fileUrl)
        .then(r => {
          if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
          return r.json();
        })
        .then(data => {
          queriesData = data;
          currentQuery = null;
          currentCategory = null;
          document.getElementById('emptyState').classList.remove('hidden');
          document.getElementById('queryView').classList.add('hidden');
          renderCategories();

          // Auto-select from URL ?c= and ?q=
          const params = new URLSearchParams(location.search);
          const cat = params.get('c');
          const qName = params.get('q');
          if (cat && qName && queriesData[cat]) {
            const queryObj = queriesData[cat].find(q => q.name === decodeURIComponent(qName));
            if (queryObj) {
              currentCategory = cat;
              const idx = queriesData[cat].indexOf(queryObj);
              selectQuery(cat, idx);
            }
          }
        })
        .catch(err => {
          console.error('Load failed:', err);
          alert(`Failed to load ${fileUrl}\n\nCheck filename and network.`);
          queriesData = {};
          renderCategories();
        });
    }

    // Dataset selector
    const datasetSelector = document.getElementById('datasetSelector');
    datasetSelector.addEventListener('change', (e) => {
      const file = e.target.value;
      loadQueries(file);
      const url = new URL(location);
      url.searchParams.set('d', file);
      history.replaceState({}, '', url);
    });

    // Initial load
    const urlParams = new URLSearchParams(location.search);
    let initialFile = urlParams.get('d');

    if (initialFile && DATASETS[initialFile]) {
      datasetSelector.value = initialFile;
    } else {
      initialFile = datasetSelector.value || 'q1.json';
      urlParams.set('d', initialFile);
      history.replaceState({}, '', '?' + urlParams);
    }
    loadQueries(initialFile);

    // Render categories and queries
    function renderCategories() {
      const container = document.getElementById('categoriesList');
      container.innerHTML = '';

      const cats = Object.keys(queriesData);
      const filteredCats = cats.filter(cat => {
        if (!searchTerm) return true;
        const catMatch = cat.toLowerCase().includes(searchTerm);
        const queryMatch = queriesData[cat].some(q =>
          q.name.toLowerCase().includes(searchTerm) ||
          (q.description && q.description.toLowerCase().includes(searchTerm))
        );
        return catMatch || queryMatch;
      });

      filteredCats.forEach(cat => {
        const queries = queriesData[cat].filter(q =>
          !searchTerm ||
          q.name.toLowerCase().includes(searchTerm) ||
          (q.description && q.description.toLowerCase().includes(searchTerm))
        );

        if (queries.length === 0) return;

        const catDiv = document.createElement('div');
        catDiv.className = 'mb-3';

        const header = document.createElement('div');
        header.className = `category-item px-4 py-3 font-semibold text-sm rounded-lg ${currentCategory === cat ? 'active' : ''}`;
        header.innerHTML = `<i class="fas fa-folder mr-2 text-indigo-500"></i>${cat} <span class="text-xs text-gray-500">(${queries.length})</span>`;
        header.onclick = () => toggleCategory(cat);
        catDiv.appendChild(header);

        if (currentCategory === cat) {
          const list = document.createElement('div');
          list.className = 'ml-6 mt-2 space-y-1';
          queries.forEach((q, i) => {
            const item = document.createElement('div');
            item.className = `query-item px-4 py-2.5 rounded-lg text-sm ${currentQuery === q ? 'active' : ''}`;
            item.innerHTML = `
              <div class="font-medium text-gray-800 dark:text-gray-200">${q.name}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">${q.description || ''}</div>
            `;
            item.onclick = (e) => { e.stopPropagation(); selectQuery(cat, i); };
            list.appendChild(item);
          });
          catDiv.appendChild(list);
        }
        container.appendChild(catDiv);
      });
    }

    function toggleCategory(cat) {
      currentCategory = currentCategory === cat ? null : cat;
      renderCategories();
    }

    function selectQuery(cat, idx) {
      const q = queriesData[cat][idx];
      currentQuery = q;
      currentCategory = cat;

      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('queryView').classList.remove('hidden');
      document.getElementById('queryTitle').textContent = q.name;
      document.getElementById('queryDescription').textContent = q.description || '';
      if (monacoEditor) monacoEditor.setValue(q.query || '');

      renderCategories();

      // Update URL for sharing
      const url = new URL(location);
      url.searchParams.set('c', encodeURIComponent(cat));
      url.searchParams.set('q', encodeURIComponent(q.name));
      history.replaceState({}, '', url);
    }

    // Search
    document.getElementById('searchInput').addEventListener('input', e => {
      searchTerm = e.target.value.toLowerCase().trim();
      renderCategories();
    });

    // Copy
    document.getElementById('copyBtn').addEventListener('click', () => {
      if (monacoEditor) {
        navigator.clipboard.writeText(monacoEditor.getValue()).then(() => {
          const btn = document.getElementById('copyBtn');
          const orig = btn.innerHTML;
          btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
          btn.classList.replace('bg-indigo-600', 'bg-green-600');
          setTimeout(() => {
            btn.innerHTML = orig;
            btn.classList.replace('bg-green-600', 'bg-indigo-600');
          }, 2000);
        });
      }
    });

    // All modal logic (Add/Edit/Delete/Save) — unchanged from your original
    // (Kept fully functional — just too long to repeat here, but it's all there in your original code)

    // Add Category
    document.getElementById('addCategoryBtn').onclick = () => {
      document.getElementById('categoryModal').classList.remove('hidden');
      document.getElementById('categoryNameInput').value = '';
    };
    document.getElementById('cancelCategoryBtn').onclick = () => document.getElementById('categoryModal').classList.add('hidden');
    document.getElementById('saveCategoryBtn').onclick = () => {
      const name = document.getElementById('categoryNameInput').value.trim();
      if (name && !queriesData[name]) {
        queriesData[name] = [];
        currentCategory = name;
        document.getElementById('categoryModal').classList.add('hidden');
        renderCategories();
      } else {
        alert('Invalid or duplicate category name');
      }
    };

    // Add/Edit Query (full logic preserved)
    document.getElementById('addQueryBtn').onclick = () => {
      editingQueryIndex = -1;
      document.getElementById('queryModalTitle').textContent = 'Add Query';
      populateCategorySelect();
      document.getElementById('queryNameInput').value = '';
      document.getElementById('queryDescInput').value = '';
      document.getElementById('queryCodeInput').value = '';
      document.getElementById('queryModal').classList.remove('hidden');
    };

    document.getElementById('editQueryBtn').onclick = () => {
      if (!currentQuery) return;
      editingQueryIndex = queriesData[currentCategory].indexOf(currentQuery);
      document.getElementById('queryModalTitle').textContent = 'Edit Query';
      populateCategorySelect();
      document.getElementById('queryCategorySelect').value = currentCategory;
      document.getElementById('queryNameInput').value = currentQuery.name;
      document.getElementById('queryDescInput').value = currentQuery.description || '';
      document.getElementById('queryCodeInput').value = currentQuery.query || '';
      document.getElementById('queryModal').classList.remove('hidden');
    };

    document.getElementById('cancelQueryBtn').onclick = () => document.getElementById('queryModal').classList.add('hidden');

    document.getElementById('saveQueryBtn').onclick = () => {
      const cat = document.getElementById('queryCategorySelect').value;
      const name = document.getElementById('queryNameInput').value.trim();
      const desc = document.getElementById('queryDescInput').value.trim();
      const query = document.getElementById('queryCodeInput').value.trim();
      if (!name || !query) return alert('Name and Query required');

      const obj = { name, description: desc, query };
      if (editingQueryIndex >= 0) {
        const oldCat = currentCategory;
        if (oldCat !== cat) {
          queriesData[oldCat].splice(editingQueryIndex, 1);
          queriesData[cat] ??= [];
          queriesData[cat].push(obj);
        } else {
          queriesData[cat][editingQueryIndex] = obj;
        }
      } else {
        queriesData[cat] ??= [];
        queriesData[cat].push(obj);
      }
      currentCategory = cat;
      document.getElementById('queryModal').classList.add('hidden');
      const idx = queriesData[cat].indexOf(obj);
      selectQuery(cat, idx);
    };

    // Delete
    document.getElementById('deleteQueryBtn').onclick = () => {
      if (!currentQuery || !confirm(`Delete "${currentQuery.name}"?`)) return;
      const idx = queriesData[currentCategory].indexOf(currentQuery);
      queriesData[currentCategory].splice(idx, 1);
      if (queriesData[currentCategory].length === 0) {
        delete queriesData[currentCategory];
        currentCategory = null;
      }
      currentQuery = null;
      document.getElementById('queryView').classList.add('hidden');
      document.getElementById('emptyState').classList.remove('hidden');
      renderCategories();
    };

    function populateCategorySelect() {
      const sel = document.getElementById('queryCategorySelect');
      sel.innerHTML = '';
      Object.keys(queriesData).forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });
    }

    // Save to file
    document.getElementById('saveBtn').onclick = () => {
      const blob = new Blob([JSON.stringify(queriesData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `soql-library-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    };

    // Resizer
    let resizing = false;
    document.getElementById('resizer').onmousedown = () => resizing = true;
    document.onmousemove = e => {
      if (!resizing) return;
      const rect = document.querySelector('.split-container').getBoundingClientRect();
      const percent = ((e.clientX - rect.left) / rect.width) * 100;
      if (percent >= 20 && percent <= 60) {
        document.getElementById('leftPane').style.flex = `0 0 ${percent}%`;
      }
    };
    document.onmouseup = () => resizing = false;

    // Initial render
    renderCategories();
  </script>
</body>
</html>