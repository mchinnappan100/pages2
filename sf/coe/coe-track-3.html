<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce COE Activity Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js v4.4.x -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <!-- date-fns for time parsing -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0"></script>
    <!-- Chart.js date adapter using date-fns -->
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        .theme-transition {
            transition: background-color 0.4s, color 0.4s;
        }

        .modal-enter {
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .draggable {
            transition: all 0.2s ease;
            cursor: grab;
        }

        .draggable:active {
            cursor: grabbing;
        }

        .draggable.dragging {
            opacity: 0.4;
            transform: scale(0.98);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .drag-over {
            border: 2px dashed #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.12) !important;
            transform: translateY(2px);
        }

        .chart-container {
            position: relative;
            height: 340px;
            width: 100%;
            max-width: 100%;
            margin: 0 auto 2rem;
        }
    </style>
</head>

<body class="theme-transition min-h-screen">
    <div id="app"></div>

    <script>
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // State
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let state = {
            theme: localStorage.getItem('theme') || 'light',
            projects: JSON.parse(localStorage.getItem('coe_projects')) || [],
            currentProjectId: localStorage.getItem('coe_current_project') || null,
            showProjectModal: false,
            showActivityModal: false,
            editingProject: null,
            editingActivity: null,
            projectForm: { title: '', description: '', createdDate: new Date().toISOString().split('T')[0] },
            activityForm: {
                title: '', category: 'Governance', status: 'Not Started', priority: 'Medium',
                assignee: '', dueDate: '', description: '', completionDate: ''
            },
            activityFilter: 'all',
            activitySort: 'dueDate',
            viewMode: 'list'   // 'list' or 'charts'
        };

        const categories = ['Governance', 'Best Practices', 'Training', 'Innovation', 'Support', 'Compliance', 'Architecture', 'Security'];
        const statuses = ['Not Started', 'In Progress', 'Blocked', 'Completed', 'On Hold'];
        const priorities = ['Low', 'Medium', 'High', 'Critical'];

        let draggedActivityId = null;
        let statusChart = null;
        let priorityChart = null;
        let categoryChart = null;
        let timelineChart = null;

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Persistence & Helpers
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function saveState() {
            localStorage.setItem('coe_projects', JSON.stringify(state.projects));
            if (state.currentProjectId) localStorage.setItem('coe_current_project', state.currentProjectId);
            else localStorage.removeItem('coe_current_project');
        }

        function getCurrentProject() {
            return state.projects.find(p => p.id === state.currentProjectId) || null;
        }

        function calculateKPIs(project = getCurrentProject()) {
            if (!project?.activities) return { total: 0, completed: 0, inProgress: 0, blocked: 0, completionRate: 0, overdue: 0 };
            const today = new Date().toISOString().split('T')[0];
            const acts = project.activities;
            const total = acts.length;
            const completed = acts.filter(a => a.status === 'Completed').length;
            const inProgress = acts.filter(a => a.status === 'In Progress').length;
            const blocked = acts.filter(a => a.status === 'Blocked').length;
            const overdue = acts.filter(a => a.dueDate && a.dueDate < today && a.status !== 'Completed').length;
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
            return { total, completed, inProgress, blocked, completionRate, overdue };
        }

        function getChartColors(isDark) {
            return isDark
                ? {
                    bg: ['#4b5563', '#60a5fa', '#f87171', '#34d399', '#a78bfa', '#fbbf24', '#ec4899'],
                    border: '#374151',
                    line: '#60a5fa'
                }
                : {
                    bg: ['#6b7280', '#3b82f6', '#ef4444', '#10b981', '#8b5cf6', '#f59e0b', '#d946ef'],
                    border: '#e5e7eb',
                    line: '#3b82f6'
                };
        }

        function updateCharts() {
            const project = getCurrentProject();
            if (!project || state.viewMode !== 'charts') return;

            const isDark = state.theme === 'dark';
            const colors = getChartColors(isDark);
            const textColor = isDark ? '#e5e7eb' : '#1f2937';
            const gridColor = isDark ? '#4b5563' : '#d1d5db';

            let acts = project.activities || [];

            // Apply filter
            if (state.activityFilter === 'open') acts = acts.filter(a => a.status !== 'Completed');
            if (state.activityFilter === 'completed') acts = acts.filter(a => a.status === 'Completed');
            if (state.activityFilter === 'blocked') acts = acts.filter(a => a.status === 'Blocked');
            if (state.activityFilter === 'high-priority') acts = acts.filter(a => ['High', 'Critical'].includes(a.priority));

            // â”€â”€ Status Pie â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const statusCounts = statuses.map(s => acts.filter(a => a.status === s).length);
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(document.getElementById('statusChart'), {
                type: 'pie',
                data: { labels: statuses, datasets: [{ data: statusCounts, backgroundColor: colors.bg, borderColor: colors.border, borderWidth: 1 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: textColor } }, title: { display: true, text: 'Status Distribution', color: textColor, font: { size: 16 } } }
                }
            });

            // â”€â”€ Priority Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const priorityCounts = priorities.map(p => acts.filter(a => a.priority === p).length);
            if (priorityChart) priorityChart.destroy();
            priorityChart = new Chart(document.getElementById('priorityChart'), {
                type: 'bar',
                data: { labels: priorities, datasets: [{ label: 'Count', data: priorityCounts, backgroundColor: colors.bg.slice(0, 4), borderColor: colors.border, borderWidth: 1 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } }, x: { ticks: { color: textColor }, grid: { display: false } } },
                    plugins: { legend: { display: false }, title: { display: true, text: 'Priority Distribution', color: textColor, font: { size: 16 } } }
                }
            });

            // â”€â”€ Category Doughnut â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const catCounts = categories.map(c => acts.filter(a => a.category === c).length);
            const activeCats = categories.filter((_, i) => catCounts[i] > 0);
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: { labels: activeCats, datasets: [{ data: catCounts.filter(n => n > 0), backgroundColor: colors.bg, borderColor: colors.border, borderWidth: 1 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: textColor } }, title: { display: true, text: 'Category Distribution', color: textColor, font: { size: 16 } } }
                }
            });

            // â”€â”€ Timeline Line Chart (Cumulative activities over time) â”€â”€
            // Sort activities by createdDate
            const sortedActs = [...acts].sort((a, b) => new Date(a.createdDate) - new Date(b.createdDate));

            const dates = [];
            const cumulative = [];
            let count = 0;

            sortedActs.forEach(act => {
                const date = dateFns.format(new Date(act.createdDate), 'yyyy-MM-dd');
                if (dates.length === 0 || dates[dates.length - 1] !== date) {
                    dates.push(date);
                    cumulative.push(++count);
                } else {
                    cumulative[cumulative.length - 1] = ++count;
                }
            });

            if (timelineChart) timelineChart.destroy();
            timelineChart = new Chart(document.getElementById('timelineChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Cumulative Activities',
                        data: cumulative,
                        borderColor: colors.line,
                        backgroundColor: colors.line + '33', // 20% opacity
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', tooltipFormat: 'yyyy-MM-dd' },
                            title: { display: true, text: 'Date', color: textColor },
                            ticks: { color: textColor, maxRotation: 45, autoSkip: true },
                            grid: { color: gridColor }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Number of Activities', color: textColor },
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: textColor } },
                        title: { display: true, text: 'Activity Creation Timeline (Cumulative)', color: textColor, font: { size: 16 } }
                    }
                }
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Drag & Drop Handlers (same as before)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function handleDragStart(e) {
            draggedActivityId = parseInt(e.currentTarget.dataset.activityId);
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.activity-item').forEach(item => item.classList.remove('drag-over'));
            draggedActivityId = null;
        }

        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }

        function handleDragEnter(e) {
            e.preventDefault();
            const item = e.currentTarget;
            if (parseInt(item.dataset.activityId) !== draggedActivityId) item.classList.add('drag-over');
        }

        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }

        function handleDrop(e) {
            e.preventDefault();
            const dropTarget = e.currentTarget;
            const dropId = parseInt(dropTarget.dataset.activityId);
            if (dropId === draggedActivityId) return;

            const project = getCurrentProject();
            if (!project) return;

            const acts = project.activities;
            const dragIdx = acts.findIndex(a => a.id === draggedActivityId);
            const dropIdx = acts.findIndex(a => a.id === dropId);

            if (dragIdx === -1 || dropIdx === -1) return;

            const [moved] = acts.splice(dragIdx, 1);
            acts.splice(dropIdx, 0, moved);

            saveState();
            render();
        }

        function selectProject(id) {
            state.currentProjectId = id;
            localStorage.setItem('coe_current_project', id);
            render();
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Render (main structure)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function render() {
            const isDark = state.theme === 'dark';
            const project = getCurrentProject();
            const kpis = calculateKPIs(project);

            document.body.className = `${isDark ? 'bg-gray-950 text-gray-100' : 'bg-gray-50 text-gray-900'} theme-transition min-h-screen`;

            let acts = project?.activities || [];

            // Filter
            if (state.activityFilter === 'open') acts = acts.filter(a => a.status !== 'Completed');
            if (state.activityFilter === 'completed') acts = acts.filter(a => a.status === 'Completed');
            if (state.activityFilter === 'blocked') acts = acts.filter(a => a.status === 'Blocked');
            if (state.activityFilter === 'high-priority') acts = acts.filter(a => ['High', 'Critical'].includes(a.priority));

            // Sort for list view only
            if (state.viewMode === 'list') {
                if (state.activitySort === 'dueDate') acts.sort((a, b) => (a.dueDate || '9999-12-31').localeCompare(b.dueDate || '9999-12-31'));
                else if (state.activitySort === 'priority') {
                    const o = { Critical: 4, High: 3, Medium: 2, Low: 1 };
                    acts.sort((a, b) => (o[b.priority] || 0) - (o[a.priority] || 0));
                } else if (state.activitySort === 'status') {
                    const o = { Completed: 1, 'In Progress': 2, Blocked: 3, 'On Hold': 4, 'Not Started': 5 };
                    acts.sort((a, b) => (o[a.status] || 99) - (o[b.status] || 99));
                } else if (state.activitySort === 'title') acts.sort((a, b) => a.title.localeCompare(b.title));
            }

            const html = `
                <div class="max-w-7xl mx-auto p-4 sm:p-6">

                    <!-- Header -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-blue-600 dark:text-blue-400">Salesforce COE Tracker</h1>
                            <p class="text-gray-600 dark:text-gray-400">Center of Excellence Activity Management</p>
                        </div>
                        <button onclick="toggleTheme()" class="p-3 rounded-xl ${isDark ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border hover:opacity-90">
                            ${isDark ? 'â˜€ï¸ Light' : 'ğŸŒ™ Dark'}
                        </button>
                    </div>

                    <!-- Projects Section (keep your existing project cards code here) -->
                    <section class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6 mb-8 border ${isDark ? 'border-gray-700' : 'border-gray-200'}">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                            <h2 class="text-2xl font-semibold">Projects</h2>
                            <button onclick="openProjectModal()" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-2 font-medium">
                                <span>+</span> New Project
                            </button>
                        </div>
                        <!-- Your project cards grid here â€“ copy from previous version -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            ${state.projects.map(p => `
                                <div onclick="selectProject(${p.id})" class="p-5 rounded-xl border-2 cursor-pointer transition-all ${state.currentProjectId === p.id ? 'border-blue-500 bg-blue-50 dark:bg-blue-950/30' : 'border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-600'}">
                                    <div class="flex justify-between items-start mb-3">
                                        <h3 class="font-semibold text-lg">${p.title}</h3>
                                        <div class="flex gap-2">
                                            <button onclick="event.stopPropagation(); editProject(${p.id})" class="text-blue-600 hover:text-blue-800 dark:text-blue-400">âœ</button>
                                            <button onclick="event.stopPropagation(); deleteProject(${p.id})" class="text-red-600 hover:text-red-800">ğŸ—‘</button>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-2">${p.description || 'â€”'}</p>
                                    <div class="text-xs text-gray-500 dark:text-gray-500">${p.activities?.length || 0} activities â€¢ ${p.createdDate}</div>
                                </div>
                            `).join('') || '<div class="col-span-full text-center py-12 text-gray-500 dark:text-gray-400">No projects yet</div>'}
                        </div>
                    </section>

                    ${project ? `
                        <!-- View Mode Tabs -->
                        <div class="flex justify-center mb-6">
                            <div class="inline-flex rounded-lg border ${isDark ? 'border-gray-700' : 'border-gray-300'} overflow-hidden shadow-sm">
                                <button onclick="state.viewMode='list'; render()" class="px-6 py-2.5 font-medium ${state.viewMode === 'list' ? 'bg-blue-600 text-white' : isDark ? 'bg-gray-800 text-gray-300' : 'bg-white text-gray-700'}">
                                    List View
                                </button>
                                <button onclick="state.viewMode='charts'; render(); setTimeout(updateCharts, 50)" class="px-6 py-2.5 font-medium ${state.viewMode === 'charts' ? 'bg-blue-600 text-white' : isDark ? 'bg-gray-800 text-gray-300' : 'bg-white text-gray-700'}">
                                    Chart View
                                </button>
                            </div>
                        </div>

                        ${state.viewMode === 'list' ? `
                            <!-- KPIs + Controls + Draggable List -->
                            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                                <!-- Your KPI cards here (total, completion %, completed, in progress, blocked, overdue) -->
                                <div class="p-5 rounded-xl ${isDark ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border shadow text-center">
                                    <div class="text-3xl font-bold text-blue-600 dark:text-blue-400">${kpis.total}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Total</div>
                                </div>
                                <!-- ... other KPI cards ... -->
                            </div>

                            <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6 mb-8 border ${isDark ? 'border-gray-700' : 'border-gray-200'}">
                                <!-- Action buttons (Add, JSON, Import, Report) -->
                                <!-- Filter & Sort controls -->
                                <!-- Draggable activities list with grip icon -->
                                <!-- Your existing list code here -->
                            </div>
                        ` : `
                            <!-- Charts View -->
                            <div class="${isDark ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6 border ${isDark ? 'border-gray-700' : 'border-gray-200'}">
                                <h2 class="text-xl font-semibold mb-8 text-center">Project Visual Analytics</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">
                                    <div class="chart-container"><canvas id="statusChart"></canvas></div>
                                    <div class="chart-container"><canvas id="priorityChart"></canvas></div>
                                    <div class="chart-container"><canvas id="categoryChart"></canvas></div>
                                    <div class="chart-container"><canvas id="timelineChart"></canvas></div>
                                </div>
                                <p class="text-center text-sm text-gray-500 dark:text-gray-400 mt-6">
                                    Showing ${acts.length} activities after applying current filter
                                </p>
                            </div>
                        `}
                    ` : ''}
                </div>

                <!-- Project & Activity Modals (keep your existing modal HTML here) -->
            `;

            document.getElementById('app').innerHTML = html;

            // Re-attach drag events if in list view
            if (state.viewMode === 'list') {
                document.querySelectorAll('.activity-item').forEach(item => {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragend', handleDragEnd);
                    item.addEventListener('dragover', handleDragOver);
                    item.addEventListener('dragenter', handleDragEnter);
                    item.addEventListener('dragleave', handleDragLeave);
                    item.addEventListener('drop', handleDrop);
                });
            }

            // Initialize charts if in chart view
            if (state.viewMode === 'charts') {
                setTimeout(updateCharts, 100); // small delay for canvas to be ready
            }

            // Enter key support in modals
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('keydown', e => {
                    if (e.key === 'Enter' && el.tagName !== 'TEXTAREA' && !e.shiftKey) {
                        e.preventDefault();
                        if (state.showProjectModal) createOrUpdateProject(!!state.editingProject);
                        if (state.showActivityModal) createOrUpdateActivity(!!state.editingActivity);
                    }
                });
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Theme toggle with chart redraw
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', state.theme);
            render();
            if (state.viewMode === 'charts') setTimeout(updateCharts, 150);
        }

        // Initial render
        render();
    </script>
</body>

</html>