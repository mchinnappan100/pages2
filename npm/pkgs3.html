<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>npm Packages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon"
        href="https://mohan-chinnappan-n5.github.io/dfv/img/mc_favIcon.ico" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <style>
        .prose-slate {
            --tw-prose-body: #e2e8f0;
            --tw-prose-headings: #60a5fa;
            --tw-prose-lead: #94a3b8;
            --tw-prose-links: #60a5fa;
            --tw-prose-bold: #e2e8f0;
            --tw-prose-counters: #94a3b8;
            --tw-prose-bullets: #475569;
            --tw-prose-hr: #334155;
            --tw-prose-quotes: #e2e8f0;
            --tw-prose-quote-borders: #60a5fa;
            --tw-prose-captions: #94a3b8;
            --tw-prose-code: #fbbf24;
            --tw-prose-pre-code: #e2e8f0;
            --tw-prose-pre-bg: #1e293b;
            --tw-prose-th-borders: #475569;
            --tw-prose-td-borders: #334155;
        }
        body { background-color: #0f172a; color: #e2e8f0; }
        .tree ul { list-style: none; padding-left: 1.5rem; }
        .tree li { margin: 0.5rem 0; }
        .tree details summary { cursor: pointer; font-weight: 600; }
        .tree details[open] > summary { color: #60a5fa; }
        .package-item { cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.375rem; }
        .package-item:hover { background-color: #1e293b; }
        .package-item.selected { background-color: #1e40af; color: white; }
        .package-item.hidden { display: none; }
        .highlight { background-color: #3b82f6; color: white; border-radius: 0.25rem; padding: 0 0.125rem; }
        #readme-content img { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 1.5rem auto; display: block; }
        .loading { opacity: 0.7; }
    </style>
</head>
<body class="h-full flex flex-col bg-slate-900 text-slate-200">
    <header class="bg-slate-800 shadow-lg p-6 text-center">
        <h1 class="text-4xl font-bold text-blue-400" id="page-title">npm Packages</h1>
        <p class="mt-2 text-slate-400" id="page-subtitle">Live collection of Node.js packages</p>
    </header>
    
    <div class="flex-1 flex flex-row overflow-hidden">
        <!-- Left Pane: Tree View with Search -->
        <aside class="w-96 bg-slate-800 border-r border-slate-700 overflow-y-auto p-6 flex flex-col">
            <div class="mb-4">
                <h2 class="text-2xl font-semibold text-blue-300 mb-3">Categories <span id="loading-indicator" class="text-sm text-slate-400">(loading...)</span></h2>
                <input type="text" id="search-input" placeholder="Search packages..." 
                       class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div id="tree-view" class="tree flex-1 overflow-y-auto">
                <p class="text-slate-400">Fetching packages from npm registry...</p>
            </div>
            <p id="no-results" class="text-center text-slate-400 mt-8 hidden">No packages match your search.</p>
        </aside>
        
        <!-- Right Pane: Details & README -->
        <main class="flex-1 overflow-y-auto p-8">
            <div id="readme-content" class="prose prose-lg max-w-4xl mx-auto prose-slate">
                <h2 class="text-3xl font-bold text-blue-300 mb-4">Select a package from the left</h2>
                <p class="text-lg text-slate-400">Use the search box to quickly find any package.</p>
            </div>
        </main>
    </div>

    <script>
        const treeView = document.getElementById('tree-view');
        const readmeContent = document.getElementById('readme-content');
        const loadingIndicator = document.getElementById('loading-indicator');
        const searchInput = document.getElementById('search-input');
        const noResults = document.getElementById('no-results');

        // Dynamic maintainer from URL ?m=username
        const urlParams = new URLSearchParams(window.location.search);
        let maintainer = urlParams.get('m') || 'mohanchinnappan';

        // Update page title and subtitle
        document.getElementById('page-title').textContent = `${maintainer}'s npm Packages`;
        document.getElementById('page-subtitle').textContent = `Live collection of Node.js packages maintained by @${maintainer} on npm`;

        const categories = {
            "Salesforce Data & Bulk Tools": [/bulk/, /upsert/, /delete/, /sfbatch/, /data-util/, /mcp/, /utils-cli/, /commons-meta/],
            "Salesforce Metadata & Config": [/meta/, /sharing/, /permset/, /profile/, /owd/, /flow/, /connected/, /dangling/, /settings/, /external-id/, /dependency/],
            "Salesforce Development & Code": [/apex/, /lwc/, /code-scanner/, /doc-generator/, /kpi/],
            "Presentation & Visualization": [/slides/, /slideshow/, /markdown/, /mermaid/, /graphviz/, /svg/, /pdf/, /video-maker/, /whisper/],
            "Data & File Comparison": [/diff/, /compare/, /datatable/, /datagen/],
            "AI-Powered Tools": [/analyze/, /rubric/, /generator-cli/],
            "General & macOS Utilities": [/uuid/, /open-resource/, /api-cli/, /diskclean/, /mac-apps/, /icon-gen/],
            "Database Tools": [/pg-/, /postgres/],
            "Other Salesforce Tools": [/erd/, /pcm/, /template/, /org-inspector/],
            "Legacy": [/generator-sfdx/]
        };

        let allPackageItems = []; // Store references for filtering

        function highlightText(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function filterPackages() {
            const query = searchInput.value.trim().toLowerCase();
            let visibleCount = 0;

            allPackageItems.forEach(item => {
                const name = item.dataset.name.toLowerCase();
                const matches = name.includes(query);

                if (matches) {
                    item.classList.remove('hidden');
                    item.innerHTML = highlightText(item.dataset.originalName, query) + 
                                     ` <span class="text-xs text-slate-400">v${item.dataset.version || '?'}</span>`;
                    visibleCount++;
                } else {
                    item.classList.add('hidden');
                }
            });

            // Show/hide categories based on visible children
            document.querySelectorAll('details').forEach(details => {
                const hasVisible = details.querySelectorAll('.package-item:not(.hidden)').length > 0;
                details.style.display = hasVisible || query === '' ? 'block' : 'none';
            });

            noResults.classList.toggle('hidden', visibleCount > 0 || query === '');
        }

        async function loadPackages() {
            try {
                const response = await fetch(`https://registry.npmjs.org/-/v1/search?text=maintainer:${maintainer}&size=250`);
                const data = await response.json();
                
                if (data.total === 0) {
                    treeView.innerHTML = `<p class="text-red-400">No packages found for @${maintainer}</p>`;
                    loadingIndicator.textContent = '';
                    return;
                }

                const packages = data.objects.map(obj => obj.package);
                
                const grouped = {};
                Object.keys(categories).forEach(cat => { grouped[cat] = []; });
                grouped["Uncategorized"] = [];

                packages.forEach(pkg => {
                    let placed = false;
                    for (const [cat, patterns] of Object.entries(categories)) {
                        if (patterns.some(p => p.test(pkg.name))) {
                            grouped[cat].push(pkg);
                            placed = true;
                            break;
                        }
                    }
                    if (!placed) grouped["Uncategorized"].push(pkg);
                });

                Object.keys(grouped).forEach(cat => {
                    grouped[cat].sort((a,b) => a.name.localeCompare(b.name));
                });

                let html = '<ul>';
                Object.keys(grouped).forEach(cat => {
                    if (grouped[cat].length === 0) return;
                    const openAttr = cat.includes('Salesforce') ? 'open' : '';
                    html += `
                        <li>
                            <details ${openAttr}>
                                <summary>${cat} (${grouped[cat].length})</summary>
                                <ul>`;
                    grouped[cat].forEach(pkg => {
                        html += `<li class="package-item" 
                                    data-name="${pkg.name}" 
                                    data-original-name="${pkg.name}"
                                    data-version="${pkg.version || 'latest'}" 
                                    data-desc="${pkg.description || ''}" 
                                    data-link="${pkg.links?.npm || 'https://www.npmjs.com/package/' + pkg.name}">
                                    ${pkg.name} <span class="text-xs text-slate-400">v${pkg.version || '?'}</span>
                                 </li>`;
                    });
                    html += `</ul></details></li>`;
                });
                html += '</ul>';

                treeView.innerHTML = html;
                loadingIndicator.textContent = `(${data.total} packages)`;

                // Cache all package items and attach events
                allPackageItems = document.querySelectorAll('.package-item');
                allPackageItems.forEach(item => {
                    item.addEventListener('click', async () => {
                        document.querySelectorAll('.package-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');

                        const name = item.dataset.name;
                        const version = item.dataset.version;
                        const desc = item.dataset.desc;
                        const link = item.dataset.link;

                        readmeContent.innerHTML = `
                            <h1 class="text-4xl font-bold text-blue-400">${name}</h1>
                            <p class="text-xl mt-6"><strong>Version:</strong> ${version}</p>
                            <p class="text-lg mt-2"><strong>Description:</strong> ${desc || 'No description'}</p>
                            <p class="mt-8"><a href="${link}" target="_blank" class="text-blue-400 underline text-lg hover:text-blue-300">View on npm â†’</a></p>
                            <hr class="my-10 border-slate-600" />
                            <h2 class="text-3xl font-semibold mb-6">README</h2>
                            <p class="loading text-lg">Loading README from npm registry...</p>
                        `;

                        try {
                            const pkgResponse = await fetch('https://registry.npmjs.org/' + name);
                            const pkgData = await pkgResponse.json();
                            const latest = pkgData['dist-tags']?.latest || version;
                            const readme = pkgData.versions[latest]?.readme || pkgData.readme || 'No README available in registry.';
                            
                            const htmlReadme = marked.parse(readme);
                            const clean = DOMPurify.sanitize(htmlReadme);
                            
                            readmeContent.querySelector('.loading').outerHTML = clean;
                        } catch (e) {
                            readmeContent.querySelector('.loading').outerHTML = '<p class="text-red-400">Failed to load README from registry.</p>';
                        }
                    });
                });

                // Attach search listener
                searchInput.addEventListener('input', filterPackages);
                searchInput.focus();

            } catch (err) {
                treeView.innerHTML = '<p class="text-red-400">Error: ' + err.message + '</p>';
                loadingIndicator.textContent = '';
            }
        }

        loadPackages();
    </script>
</body>
</html>