<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mermaid Diagram</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
 <link rel="icon" type="image/x-icon" href="https://mohan-chinnappan-n5.github.io/dfv/img/mc_favIcon.ico" />
<script type="module">
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
  window.mermaid = mermaid;
  mermaid.initialize({ startOnLoad: false, theme: "dark", securityLevel: "loose" });
</script>
<style>
html,body {height:100%; margin:0;}
#container {display:flex; height:100vh; overflow:hidden;}
#editorPane {width:50%; resize:horizontal; overflow:auto; background:#0b1220; border-right:2px solid #222;}
#diagramPane {flex:1; overflow:auto; background:#0b1220;}
textarea {
  width:100%; height:calc(100vh - 60px);
  font-family:monospace; font-size:14px;
  background:#071020; color:#dbeafe;
  padding:12px; border:none; outline:none;
  resize:none;
}
.splitter {
  width:6px; background:#333; cursor:col-resize;
}
.diagram-inner { transform-origin: 0 0; transition: transform 0.12s ease; }
button { min-width:100px; }
</style>
</head>
<body class="bg-zinc-900 text-zinc-100">
<header class="p-3 bg-zinc-800 flex justify-between items-center border-b border-zinc-700">
  <div><strong>Mermaid Diagram</strong> <span class="text-sm text-zinc-400">(code-exec2.mmd)</span></div>
  <div class="space-x-2">
    <button id="saveBtn" class="bg-emerald-600 px-3 py-1 rounded hover:bg-emerald-700">üíæ Save</button>
    <button id="zoomIn" class="bg-sky-600 px-3 py-1 rounded hover:bg-sky-700">üîç+</button>
    <button id="zoomOut" class="bg-sky-600 px-3 py-1 rounded hover:bg-sky-700">üîç-</button>
    <button id="resetZoom" class="bg-zinc-700 px-3 py-1 rounded hover:bg-zinc-600">‚Ü∫ Reset</button>
    <button id="downloadSvg" class="bg-emerald-600 px-3 py-1 rounded hover:bg-emerald-700">‚¨á SVG</button>
    <button id="downloadPng" style='display:none;' class="bg-emerald-600 px-3 py-1 rounded hover:bg-emerald-700">‚¨á PNG</button>
  </div>
</header>

<div id="container">
  <div id="editorPane">
    <textarea id="sourceArea">graph LR
    %% === Primary Flow ===
    A([üßë‚Äçüíª User Request]) --&gt; B((ü§ñ LLM Agent))
    
    %% === Model Context Window ===
    subgraph MCW[üß† Model Context Window]
        B --&gt; C[[üì¶ Tool Definitions&lt;br/&gt;Loaded On Demand]]
        G --&gt; H[[üìä Final/Filtered Result&lt;br/&gt;Minimal Data]]
    end
    
    B --&gt; D[[üóÇÔ∏è Explore Filesystem /&lt;br/&gt;Servers]]
    D --&gt; C
    B --&gt; E{{üß© Generated Code&lt;br/&gt;Snippet}}
    
    %% === Code Execution Environment ===
    subgraph CEE[üíª Code Execution Environment - CEE]
        E --&gt; F([‚ñ∂Ô∏è Run Code:&lt;br/&gt;import gdrive...])
        F --&gt; I[[üîß Call callMCPTool&lt;br/&gt;tool_id, ...]]
        I --&gt; J([üåê MCP Server /&lt;br/&gt;External System])
        J --&gt; K([üì• Return Full Data])
        K --&gt; L([üåÄ Data Processing /&lt;br/&gt;Filtering / Loops in CEE])
        L --&gt; G([ü™∂ Log / Return&lt;br/&gt;Filtered Result])
    end
    
    %% === Return Loop and Output ===
    H --&gt; B
    B --&gt; M{{üßæ Final Context-&lt;br/&gt;Efficient Response}}
    
    %% === Key Benefits Annotation ===
    subgraph KB[üåü Key Benefits]
        N[1Ô∏è‚É£ Progressive Disclosure&lt;br/&gt;Load tools only when needed]
        O[2Ô∏è‚É£ Context-Efficient Results&lt;br/&gt;Filter data outside LLM context]
        P[3Ô∏è‚É£ Complex Control Flow&lt;br/&gt;Loops &amp; conditionals in generated code]
    end
    
    M --&gt; KB
    
    %% === Enhanced Styling ===
    
    %% User Entry Point
    style A fill:#667eea,stroke:#4c51bf,stroke-width:3px,color:#fff,font-weight:bold
    
    %% Core LLM Agent - Purple gradient effect
    style B fill:#764ba2,stroke:#f093fb,stroke-width:4px,color:#fff,font-weight:bold
    
    %% Model Context Window - Cool blue tones
    style MCW fill:#e0f2fe,stroke:#0369a1,stroke-width:2px,color:#0c4a6e
    style C fill:#7dd3fc,stroke:#0284c7,stroke-width:2px,color:#0c4a6e
    style H fill:#7dd3fc,stroke:#0284c7,stroke-width:2px,color:#0c4a6e
    
    %% Filesystem/Servers - Purple accent
    style D fill:#e9d5ff,stroke:#9333ea,stroke-width:2px,color:#581c87
    
    %% Generated Code
    style E fill:#fbbf24,stroke:#d97706,stroke-width:2px,color:#78350f,font-weight:bold
    
    %% Code Execution Environment - Warm amber tones
    style CEE fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#78350f
    style F fill:#fcd34d,stroke:#f59e0b,stroke-width:2px,color:#78350f
    style I fill:#fde68a,stroke:#f59e0b,stroke-width:2px,color:#78350f
    style L fill:#fef08a,stroke:#eab308,stroke-width:2px,color:#713f12
    
    %% External Systems - Coral/Pink
    style J fill:#fda4af,stroke:#f43f5e,stroke-width:2px,color:#881337,font-weight:bold
    style K fill:#fda4af,stroke:#f43f5e,stroke-width:2px,color:#881337
    
    %% Return Result
    style G fill:#86efac,stroke:#22c55e,stroke-width:2px,color:#14532d
    
    %% Final Output - Success green
    style M fill:#4ade80,stroke:#16a34a,stroke-width:3px,color:#14532d,font-weight:bold
    
    %% Key Benefits Box - Gradient purple to blue
    style KB fill:#f3e8ff,stroke:#a855f7,stroke-width:2px,color:#581c87
    style N fill:#ddd6fe,stroke:#8b5cf6,stroke-width:1px,color:#4c1d95
    style O fill:#ddd6fe,stroke:#8b5cf6,stroke-width:1px,color:#4c1d95
    style P fill:#ddd6fe,stroke:#8b5cf6,stroke-width:1px,color:#4c1d95</textarea>
  </div>
  <div class="splitter" id="splitter"></div>
  <div id="diagramPane"><div id="diagramInner" class="diagram-inner p-4"></div></div>
</div>

<script type="module">
  const sourceArea = document.getElementById("sourceArea");
  const diagramInner = document.getElementById("diagramInner");
  const mermaidSrc = "graph LR\n    %% === Primary Flow ===\n    A([üßë‚Äçüíª User Request]) --> B((ü§ñ LLM Agent))\n    \n    %% === Model Context Window ===\n    subgraph MCW[üß† Model Context Window]\n        B --> C[[üì¶ Tool Definitions<br/>Loaded On Demand]]\n        G --> H[[üìä Final/Filtered Result<br/>Minimal Data]]\n    end\n    \n    B --> D[[üóÇÔ∏è Explore Filesystem /<br/>Servers]]\n    D --> C\n    B --> E{{üß© Generated Code<br/>Snippet}}\n    \n    %% === Code Execution Environment ===\n    subgraph CEE[üíª Code Execution Environment - CEE]\n        E --> F([‚ñ∂Ô∏è Run Code:<br/>import gdrive...])\n        F --> I[[üîß Call callMCPTool<br/>tool_id, ...]]\n        I --> J([üåê MCP Server /<br/>External System])\n        J --> K([üì• Return Full Data])\n        K --> L([üåÄ Data Processing /<br/>Filtering / Loops in CEE])\n        L --> G([ü™∂ Log / Return<br/>Filtered Result])\n    end\n    \n    %% === Return Loop and Output ===\n    H --> B\n    B --> M{{üßæ Final Context-<br/>Efficient Response}}\n    \n    %% === Key Benefits Annotation ===\n    subgraph KB[üåü Key Benefits]\n        N[1Ô∏è‚É£ Progressive Disclosure<br/>Load tools only when needed]\n        O[2Ô∏è‚É£ Context-Efficient Results<br/>Filter data outside LLM context]\n        P[3Ô∏è‚É£ Complex Control Flow<br/>Loops & conditionals in generated code]\n    end\n    \n    M --> KB\n    \n    %% === Enhanced Styling ===\n    \n    %% User Entry Point\n    style A fill:#667eea,stroke:#4c51bf,stroke-width:3px,color:#fff,font-weight:bold\n    \n    %% Core LLM Agent - Purple gradient effect\n    style B fill:#764ba2,stroke:#f093fb,stroke-width:4px,color:#fff,font-weight:bold\n    \n    %% Model Context Window - Cool blue tones\n    style MCW fill:#e0f2fe,stroke:#0369a1,stroke-width:2px,color:#0c4a6e\n    style C fill:#7dd3fc,stroke:#0284c7,stroke-width:2px,color:#0c4a6e\n    style H fill:#7dd3fc,stroke:#0284c7,stroke-width:2px,color:#0c4a6e\n    \n    %% Filesystem/Servers - Purple accent\n    style D fill:#e9d5ff,stroke:#9333ea,stroke-width:2px,color:#581c87\n    \n    %% Generated Code\n    style E fill:#fbbf24,stroke:#d97706,stroke-width:2px,color:#78350f,font-weight:bold\n    \n    %% Code Execution Environment - Warm amber tones\n    style CEE fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#78350f\n    style F fill:#fcd34d,stroke:#f59e0b,stroke-width:2px,color:#78350f\n    style I fill:#fde68a,stroke:#f59e0b,stroke-width:2px,color:#78350f\n    style L fill:#fef08a,stroke:#eab308,stroke-width:2px,color:#713f12\n    \n    %% External Systems - Coral/Pink\n    style J fill:#fda4af,stroke:#f43f5e,stroke-width:2px,color:#881337,font-weight:bold\n    style K fill:#fda4af,stroke:#f43f5e,stroke-width:2px,color:#881337\n    \n    %% Return Result\n    style G fill:#86efac,stroke:#22c55e,stroke-width:2px,color:#14532d\n    \n    %% Final Output - Success green\n    style M fill:#4ade80,stroke:#16a34a,stroke-width:3px,color:#14532d,font-weight:bold\n    \n    %% Key Benefits Box - Gradient purple to blue\n    style KB fill:#f3e8ff,stroke:#a855f7,stroke-width:2px,color:#581c87\n    style N fill:#ddd6fe,stroke:#8b5cf6,stroke-width:1px,color:#4c1d95\n    style O fill:#ddd6fe,stroke:#8b5cf6,stroke-width:1px,color:#4c1d95\n    style P fill:#ddd6fe,stroke:#8b5cf6,stroke-width:1px,color:#4c1d95";
  const filePath = "/Users/mchinnappan/github-pages/pages2/mcp/code-exec2.mmd";
  let currentScale = 1;
  const SCALE_STEP = 0.15;
  const MAX_SCALE = 5;
  const MIN_SCALE = 0.1;

  async function renderMermaid(text) {
    try {
      const { svg } = await mermaid.mermaidAPI.render("mmd-" + Date.now(), text);
      diagramInner.innerHTML = svg;
      const svgEl = diagramInner.querySelector("svg");
      if (svgEl) { svgEl.removeAttribute("width"); svgEl.removeAttribute("height"); }
      setScale(1);
    } catch (err) {
      diagramInner.innerHTML = '<pre class="text-red-400">Error: ' + err.message + '</pre>';
    }
  }
  function setScale(s) {
    currentScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, s));
    const target = diagramInner.firstElementChild;
    if (target && target.style) {
      target.style.transform = 'scale(' + currentScale + ')';
      target.style.transformOrigin = '0 0';
    }
  }

  // Debounce rendering
  let renderTimeout;
  sourceArea.addEventListener("input", () => {
    clearTimeout(renderTimeout);
    renderTimeout = setTimeout(() => renderMermaid(sourceArea.value), 600);
  });

  // Save back to disk
  document.getElementById("saveBtn").addEventListener("click", async () => {
    const text = sourceArea.value;
    const res = await fetch("file://" + filePath, { method: "PUT", body: text });
    alert("This button cannot directly write to disk from browser. Copy text manually or use CLI to save.");
  });

  // Download SVG
  document.getElementById("downloadSvg").addEventListener("click", () => {
    const svg = diagramInner.querySelector("svg");
    if (!svg) return alert("No SVG found");
    const serializer = new XMLSerializer();
    const svgText = '<?xml version="1.0"?>\n' + serializer.serializeToString(svg);
    const blob = new Blob([svgText], { type: "image/svg+xml" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "diagram.svg";
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 3000);
  });

  // Download PNG
  document.getElementById("downloadPng").addEventListener("click", async () => {
    const svg = diagramInner.querySelector("svg");
    if (!svg) return alert("No SVG found");
    const serializer = new XMLSerializer();
    const svgText = serializer.serializeToString(svg);
    const blob = new Blob([svgText], { type: "image/svg+xml" });
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = img.width * currentScale;
      canvas.height = img.height * currentScale;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#0b1220"; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(b => {
        const a = document.createElement("a");
        const u2 = URL.createObjectURL(b);
        a.href = u2; a.download = "diagram.png"; a.click();
        setTimeout(() => URL.revokeObjectURL(u2), 3000);
      }, "image/png");
      URL.revokeObjectURL(url);
    };
    img.src = url;
  });

  // Zoom
  document.getElementById("zoomIn").onclick = () => setScale(currentScale + SCALE_STEP);
  document.getElementById("zoomOut").onclick = () => setScale(currentScale - SCALE_STEP);
  document.getElementById("resetZoom").onclick = () => setScale(1);

  // Splitter
  const splitter = document.getElementById("splitter");
  const editor = document.getElementById("editorPane");
  splitter.addEventListener("mousedown", startDrag);
  function startDrag(e) {
    e.preventDefault();
    const startX = e.clientX;
    const startWidth = editor.offsetWidth;
    function onMove(ev) {
      const delta = ev.clientX - startX;
      editor.style.width = (startWidth + delta) + "px";
    }
    function onUp() {
      window.removeEventListener("mousemove", onMove);
      window.removeEventListener("mouseup", onUp);
    }
    window.addEventListener("mousemove", onMove);
    window.addEventListener("mouseup", onUp);
  }

  // Initial render
  renderMermaid(mermaidSrc);
</script>
</body>
</html>