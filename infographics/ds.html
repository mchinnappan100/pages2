<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Diagram Studio</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="icon" type="image/x-icon" href="https://mohan-chinnappan-n5.github.io/dfv/img/mc_favIcon.ico" />
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.51.0/min/vs/loader.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

/* ‚îÄ‚îÄ Themes ‚îÄ‚îÄ */
:root{
  --bg:#0a0c14;--bg2:#111320;--bg3:#1a1d2e;--border:#252840;
  --text:#e4e6f0;--text-muted:#5a6080;
  --accent:#5b6ef5;--accent2:#8b5cf6;--accent-glow:rgba(91,110,245,.22);
  --node-fill:#1a1d2e;--node-stroke:#5b6ef5;--node-hover:#22263d;
  --conn:#2e3260;--conn-hi:#5b6ef5;
  --center-fill:#5b6ef5;--center-text:#fff;--node-text:#c8ccee;
  --shadow:rgba(0,0,0,.6);--header-bg:rgba(10,12,20,.94);
  --shape-a:#5b6ef5;--shape-b:#8b5cf6;--shape-c:#22d3ee;--shape-d:#f59e0b;
}
[data-theme="arctic"]{
  --bg:#f0f4ff;--bg2:#e4eaff;--bg3:#d8e0ff;--border:#c0caf5;
  --text:#1a1d3a;--text-muted:#6b7096;
  --accent:#4f5ef0;--accent2:#7c3aed;--accent-glow:rgba(79,94,240,.12);
  --node-fill:#fff;--node-stroke:#4f5ef0;--node-hover:#eef0ff;
  --conn:#a5b4fc;--conn-hi:#4f5ef0;
  --center-fill:#4f5ef0;--center-text:#fff;--node-text:#1a1d3a;
  --shadow:rgba(0,0,50,.1);--header-bg:rgba(240,244,255,.96);
  --shape-a:#4f5ef0;--shape-b:#7c3aed;--shape-c:#0891b2;--shape-d:#d97706;
}
[data-theme="ember"]{
  --bg:#100a06;--bg2:#1a100a;--bg3:#241510;--border:#3a2018;
  --text:#f5e0c8;--text-muted:#8a6050;
  --accent:#f0722a;--accent2:#e84040;--accent-glow:rgba(240,114,42,.22);
  --node-fill:#1f130b;--node-stroke:#f0722a;--node-hover:#2a1a0e;
  --conn:#4a2810;--conn-hi:#f0722a;
  --center-fill:#f0722a;--center-text:#100a06;--node-text:#f5d0a0;
  --shadow:rgba(0,0,0,.7);--header-bg:rgba(16,10,6,.96);
  --shape-a:#f0722a;--shape-b:#e84040;--shape-c:#fbbf24;--shape-d:#34d399;
}
[data-theme="forest"]{
  --bg:#080e0a;--bg2:#0d1610;--bg3:#121f15;--border:#1e3020;
  --text:#c8e8cc;--text-muted:#5a7060;
  --accent:#3ecf6c;--accent2:#22c55e;--accent-glow:rgba(62,207,108,.18);
  --node-fill:#0f1f12;--node-stroke:#3ecf6c;--node-hover:#162918;
  --conn:#1e4024;--conn-hi:#3ecf6c;
  --center-fill:#3ecf6c;--center-text:#080e0a;--node-text:#a0dca8;
  --shadow:rgba(0,0,0,.7);--header-bg:rgba(8,14,10,.96);
  --shape-a:#3ecf6c;--shape-b:#22c55e;--shape-c:#facc15;--shape-d:#f87171;
}
[data-theme="rose"]{
  --bg:#fdf2f8;--bg2:#fce7f3;--bg3:#fbcfe8;--border:#f9a8d4;
  --text:#4a0d2e;--text-muted:#9d6080;
  --accent:#db2777;--accent2:#9333ea;--accent-glow:rgba(219,39,119,.12);
  --node-fill:#fff5f9;--node-stroke:#db2777;--node-hover:#fce7f3;
  --conn:#f9a8d4;--conn-hi:#db2777;
  --center-fill:#db2777;--center-text:#fff;--node-text:#4a0d2e;
  --shadow:rgba(219,39,119,.12);--header-bg:rgba(253,242,248,.96);
  --shape-a:#db2777;--shape-b:#9333ea;--shape-c:#0284c7;--shape-d:#16a34a;
}

html,body{height:100%;font-family:'DM Sans',sans-serif;}
body{background:var(--bg);color:var(--text);transition:background .3s,color .3s;overflow:hidden;}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
header{
  position:sticky;top:0;z-index:100;
  background:var(--header-bg);border-bottom:1px solid var(--border);
  backdrop-filter:blur(16px);
}
.hdr{display:flex;align-items:center;gap:8px;padding:9px 16px;flex-wrap:wrap;}

.logo{
  font-family:'Syne',sans-serif;font-weight:800;font-size:18px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  white-space:nowrap;margin-right:4px;letter-spacing:-.3px;
}

.divv{width:1px;height:20px;background:var(--border);flex-shrink:0;}
.spacer{flex:1;}

.btn{
  display:inline-flex;align-items:center;gap:5px;
  font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;
  padding:6px 12px;border-radius:8px;border:1px solid var(--border);
  cursor:pointer;transition:all .18s;white-space:nowrap;
  background:var(--bg3);color:var(--text);
}
.btn:hover{border-color:var(--accent);color:var(--accent);transform:translateY(-1px);}
.btn:active{transform:translateY(0);}
.btn svg{width:13px;height:13px;flex-shrink:0;}
.btn-accent{background:var(--accent);border-color:var(--accent);color:#fff;}
.btn-accent:hover{opacity:.85;color:#fff;}

.theme-sel{
  font-family:'DM Sans',sans-serif;font-size:12px;
  background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  padding:6px 10px;color:var(--text);cursor:pointer;outline:none;
}
.theme-sel:hover{border-color:var(--accent);}
.theme-sel option{background:var(--bg3);}

/* ‚îÄ‚îÄ Diagram type tabs ‚îÄ‚îÄ */
.type-tabs{
  display:flex;gap:4px;background:var(--bg2);border-bottom:1px solid var(--border);
  padding:8px 12px;flex-shrink:0;overflow-x:auto;
}
.type-tab{
  display:flex;align-items:center;gap:6px;
  font-family:'DM Mono',monospace;font-size:11px;font-weight:500;
  padding:6px 14px;border-radius:8px;border:1px solid transparent;
  cursor:pointer;transition:all .18s;color:var(--text-muted);white-space:nowrap;
}
.type-tab svg{width:14px;height:14px;}
.type-tab:hover{background:var(--bg3);color:var(--text);}
.type-tab.active{background:var(--accent-glow);border-color:var(--accent);color:var(--accent);}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.layout{display:flex;height:calc(100vh - 104px);}

.editor-pane{
  display:flex;flex-direction:column;min-width:220px;max-width:55%;width:36%;
  background:var(--bg2);border-right:1px solid var(--border);
}
.editor-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg);flex-shrink:0;}
.editor-tab{
  font-family:'DM Mono',monospace;font-size:11px;
  padding:7px 14px;cursor:pointer;border-right:1px solid var(--border);
  color:var(--text-muted);transition:all .18s;user-select:none;
}
.editor-tab.active{color:var(--accent);background:var(--bg2);border-bottom:2px solid var(--accent);}
.editor-tab:hover:not(.active){color:var(--text);}

#monaco-editor{flex:1;overflow:hidden;}

.splitter{
  width:5px;background:var(--border);cursor:col-resize;
  transition:background .2s;flex-shrink:0;position:relative;
}
.splitter::after{content:'';position:absolute;inset:0 -4px;}
.splitter:hover,.splitter.active{background:var(--accent);}

/* ‚îÄ‚îÄ Canvas ‚îÄ‚îÄ */
.canvas-pane{flex:1;position:relative;overflow:hidden;background:var(--bg);}
.canvas-bg-dots{
  position:absolute;inset:0;
  background-image:radial-gradient(circle,var(--border) 1px,transparent 1px);
  background-size:28px 28px;opacity:.45;pointer-events:none;
}
#diagram-svg{position:absolute;inset:0;width:100%;height:100%;user-select:none;}

/* ‚îÄ‚îÄ Canvas toolbar ‚îÄ‚îÄ */
.canvas-toolbar{
  position:absolute;bottom:16px;left:50%;transform:translateX(-50%);
  display:flex;align-items:center;gap:3px;
  background:var(--bg2);border:1px solid var(--border);border-radius:12px;
  padding:5px 8px;backdrop-filter:blur(12px);box-shadow:0 8px 32px var(--shadow);
  z-index:10;
}
.cb{
  font-size:11px;font-family:'DM Mono',monospace;
  background:none;border:1px solid transparent;border-radius:7px;
  padding:5px 10px;color:var(--text-muted);cursor:pointer;
  transition:all .18s;display:flex;align-items:center;gap:5px;
}
.cb:hover{border-color:var(--border);color:var(--text);background:var(--bg3);}
.cb.active{border-color:var(--accent);color:var(--accent);background:var(--accent-glow);}
.cb svg{width:13px;height:13px;}
.cdiv{width:1px;height:16px;background:var(--border);margin:0 2px;}

/* ‚îÄ‚îÄ Overlays ‚îÄ‚îÄ */
.zoom-badge{
  position:absolute;top:12px;right:12px;
  font-family:'DM Mono',monospace;font-size:11px;color:var(--text-muted);
  background:var(--bg2);border:1px solid var(--border);
  padding:4px 10px;border-radius:6px;pointer-events:none;
}

.detail-panel{
  position:absolute;top:12px;left:12px;
  background:var(--bg2);border:1px solid var(--border);border-radius:12px;
  padding:14px 14px 12px;min-width:190px;
  box-shadow:0 8px 32px var(--shadow);display:none;z-index:20;
}
.detail-panel.show{display:block;}
.dp-title{
  font-family:'Syne',sans-serif;font-size:10px;font-weight:700;
  color:var(--accent);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px;
}
.dp-close{
  position:absolute;top:8px;right:8px;background:none;border:none;
  color:var(--text-muted);cursor:pointer;font-size:15px;padding:2px 6px;
  border-radius:4px;
}
.dp-close:hover{background:var(--bg3);color:var(--text);}
.dp-field{
  width:100%;background:var(--bg3);border:1px solid var(--border);
  border-radius:7px;padding:6px 10px;font-size:13px;
  font-family:'DM Sans',sans-serif;color:var(--text);outline:none;
  margin-bottom:8px;transition:border-color .2s;
}
.dp-field:focus{border-color:var(--accent);}
.dp-label{font-size:10px;color:var(--text-muted);font-family:'DM Mono',monospace;margin-bottom:3px;}
.dp-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
select.dp-field{cursor:pointer;}

.toast{
  position:fixed;bottom:80px;left:50%;
  transform:translateX(-50%) translateY(16px);
  background:var(--bg3);border:1px solid var(--accent);color:var(--text);
  font-size:12px;font-family:'DM Mono',monospace;padding:7px 16px;
  border-radius:8px;opacity:0;transition:all .25s;pointer-events:none;z-index:999;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ‚îÄ‚îÄ Help panel ‚îÄ‚îÄ */
.help-body{
  flex:1;overflow:auto;padding:18px;
  font-family:'DM Mono',monospace;font-size:11.5px;
  color:var(--text-muted);line-height:1.9;
}
.help-h{
  font-family:'Syne',sans-serif;font-size:11px;font-weight:700;
  color:var(--accent);text-transform:uppercase;letter-spacing:.08em;
  margin:14px 0 6px;
}
.help-pre{
  background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  padding:12px;margin-top:6px;font-size:11px;overflow-x:auto;
  color:var(--node-text);
}
</style>
</head>
<body data-theme="cosmic">

<header>
  <div class="hdr">
    <div class="logo">‚óà DiagramStudio</div>
    <div class="divv"></div>

    <!-- Dynamic add button changes based on diagram type -->
    <button class="btn btn-accent" id="addNodeBtn" onclick="diagramAddNode()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
      <span id="addNodeLabel">Add Node</span>
    </button>

    <div class="divv"></div>

    <button class="btn" onclick="uploadFile()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 16a4 4 0 01-.88-7.9A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3-3 3m3-3v12"/></svg>
      Import
    </button>
    <button class="btn" onclick="downloadJSON()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4-4-4m4 4V4"/></svg>
      JSON
    </button>
    <button class="btn" onclick="exportSVG()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
      SVG
    </button>
    <button class="btn" onclick="exportPNG()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
      PNG
    </button>

    <div class="spacer"></div>

    <select class="theme-sel" onchange="setTheme(this.value)">
      <option value="cosmic">üåå Cosmic</option>
      <option value="arctic">üèî Arctic</option>
      <option value="ember">üî• Ember</option>
      <option value="forest">üåø Forest</option>
      <option value="rose">üå∏ Rose</option>
    </select>
  </div>
</header>

<!-- Diagram type selector -->
<div class="type-tabs" id="typeTabs">
  <div class="type-tab active" data-type="hubspoke" onclick="switchDiagramType('hubspoke')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><circle cx="4" cy="8" r="2"/><circle cx="20" cy="8" r="2"/><circle cx="4" cy="16" r="2"/><circle cx="20" cy="16" r="2"/><line x1="8" y1="10" x2="10" y2="11"/><line x1="16" y1="10" x2="14" y2="11"/><line x1="8" y1="14" x2="10" y2="13"/><line x1="16" y1="14" x2="14" y2="13"/></svg>
    Hub-Spoke
  </div>
  <div class="type-tab" data-type="flowchart" onclick="switchDiagramType('flowchart')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="6" height="4" rx="1"/><polygon points="12,2 16,7 12,12 8,7"/><rect x="9" y="15" width="6" height="4" rx="1"/><line x1="6" y1="7" x2="6" y2="9"/><line x1="6" y1="9" x2="12" y2="9"/><line x1="12" y1="9" x2="12" y2="12"/><line x1="12" y1="12" x2="12" y2="15"/></svg>
    Flowchart
  </div>
  <div class="type-tab" data-type="mindmap" onclick="switchDiagramType('mindmap')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><circle cx="4" cy="6" r="2"/><circle cx="20" cy="6" r="2"/><circle cx="4" cy="18" r="2"/><circle cx="20" cy="18" r="2"/><circle cx="12" cy="2" r="2"/><path d="M14 10l4-3M10 10l-4-3M14 14l4 3M10 14l-4 3M12 9V4"/></svg>
    Mind Map
  </div>
  <div class="type-tab" data-type="orgchart" onclick="switchDiagramType('orgchart')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="2" width="6" height="4" rx="1"/><rect x="3" y="10" width="6" height="4" rx="1"/><rect x="15" y="10" width="6" height="4" rx="1"/><rect x="3" y="18" width="6" height="4" rx="1"/><line x1="12" y1="6" x2="12" y2="8"/><line x1="6" y1="8" x2="18" y2="8"/><line x1="6" y1="8" x2="6" y2="10"/><line x1="18" y1="8" x2="18" y2="10"/><line x1="6" y1="14" x2="6" y2="18"/></svg>
    Org Chart
  </div>
  <div class="type-tab" data-type="sequence" onclick="switchDiagramType('sequence')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="5" height="4" rx="1"/><rect x="17" y="2" width="5" height="4" rx="1"/><line x1="4" y1="6" x2="4" y2="22"/><line x1="20" y1="6" x2="20" y2="22"/><line x1="4" y1="9" x2="20" y2="9"/><line x1="17" y1="7" x2="20" y2="9"/><line x1="17" y1="11" x2="20" y2="9"/><line x1="20" y1="15" x2="4" y2="15"/><line x1="7" y1="13" x2="4" y2="15"/><line x1="7" y1="17" x2="4" y2="15"/></svg>
    Sequence
  </div>
  <div class="type-tab" data-type="er" onclick="switchDiagramType('er')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="8" height="12" rx="1"/><rect x="14" y="6" width="8" height="12" rx="1"/><line x1="10" y1="9" x2="14" y2="9"/><line x1="10" y1="12" x2="14" y2="12"/><line x1="10" y1="15" x2="14" y2="15"/></svg>
    ER Diagram
  </div>
</div>

<div class="layout">
  <!-- Editor -->
  <div class="editor-pane" id="editorPane">
    <div class="editor-tabs">
      <div class="editor-tab active" onclick="switchEdTab('json')">schema.json</div>
      <div class="editor-tab" onclick="switchEdTab('help')">help</div>
    </div>
    <div id="monaco-editor" style="flex:1;overflow:hidden;display:flex;"></div>
    <div class="help-body" id="helpTab" style="display:none;">
      <div class="help-h">Controls</div>
      Drag nodes to reposition ¬∑ Double-click to rename<br>
      Drag ‚óÜ edge handles to bend connectors<br>
      Space+drag to pan ¬∑ Ctrl+scroll to zoom<br>
      Delete key removes selected node<br>

      <div class="help-h">Diagram Types</div>
      <b style="color:var(--text)">Hub-Spoke</b> ‚Äî central node with left/right spokes<br>
      <b style="color:var(--text)">Flowchart</b> ‚Äî process nodes with directional arrows<br>
      <b style="color:var(--text)">Mind Map</b> ‚Äî radial branch layout<br>
      <b style="color:var(--text)">Org Chart</b> ‚Äî hierarchical tree structure<br>
      <b style="color:var(--text)">Sequence</b> ‚Äî actors + timed messages<br>
      <b style="color:var(--text)">ER Diagram</b> ‚Äî entities with attribute fields<br>

      <div class="help-h">Flowchart Node Shapes</div>
      <code class="help-pre">shape: "rect" | "diamond" | "oval" | "parallelogram" | "cylinder"</code>

      <div class="help-h">ER Field Types</div>
      <code class="help-pre">type: "PK" | "FK" | "field"</code>

      <div class="help-h">Sequence Arrow Types</div>
      <code class="help-pre">type: "solid" | "dashed" | "return"</code>
    </div>
  </div>

  <div class="splitter" id="splitter"></div>

  <!-- Canvas -->
  <div class="canvas-pane" id="canvasPane">
    <div class="canvas-bg-dots"></div>
    <svg id="diagram-svg" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
          <feGaussianBlur stdDeviation="3.5" result="b"/>
          <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
        <marker id="arrow" markerWidth="9" markerHeight="9" refX="8" refY="3" orient="auto">
          <path d="M0,0 L0,6 L9,3 z" fill="var(--conn-hi)"/>
        </marker>
        <marker id="arrow-dashed" markerWidth="9" markerHeight="9" refX="8" refY="3" orient="auto">
          <path d="M0,0 L0,6 L9,3 z" fill="var(--conn)" stroke="none"/>
        </marker>
      </defs>
      <g id="canvas-group"></g>
    </svg>

    <div class="zoom-badge" id="zoomBadge">100%</div>

    <!-- Detail panel -->
    <div class="detail-panel" id="detailPanel">
      <div class="dp-title" id="dpTitle">Node</div>
      <button class="dp-close" onclick="closeDp()">√ó</button>
      <div class="dp-label">Label</div>
      <input class="dp-field" id="dpLabel" oninput="updateNodeLabel(this.value)">
      <div class="dp-label">Shape / Type</div>
      <select class="dp-field" id="dpShape" onchange="updateNodeShape(this.value)">
        <option value="rect">Rectangle</option>
        <option value="diamond">Diamond</option>
        <option value="oval">Oval / Start-End</option>
        <option value="parallelogram">Parallelogram</option>
        <option value="cylinder">Cylinder / DB</option>
        <option value="circle">Circle</option>
      </select>
      <div class="dp-label">Color</div>
      <div class="dp-row">
        <input type="color" id="dpColor" oninput="updateNodeColor(this.value)" style="border:none;background:none;cursor:pointer;width:36px;height:28px;">
        <button class="btn" style="flex:1;justify-content:center;font-size:11px;" onclick="resetNodeColor()">Reset</button>
      </div>
      <button class="btn" style="width:100%;justify-content:center;margin-top:4px;color:#f87171;border-color:#f87171;" onclick="deleteSelected()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;"><path d="M3 6h18M19 6l-1 14H6L5 6M10 11v6M14 11v6M9 6V4h6v2"/></svg>
        Delete Node
      </button>
    </div>

    <!-- Canvas toolbar -->
    <div class="canvas-toolbar">
      <button class="cb active" id="btnSelect" onclick="setMode('select')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3l14 9-7 1-4 7z"/></svg> Select
      </button>
      <button class="cb" id="btnPan" onclick="setMode('pan')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3"/></svg> Pan
      </button>
      <div class="cdiv"></div>
      <button class="cb" onclick="zoomIn()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35M8 11h6M11 8v6"/></svg>
      </button>
      <button class="cb" onclick="zoomOut()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35M8 11h6"/></svg>
      </button>
      <button class="cb" onclick="resetView()">Fit</button>
      <div class="cdiv"></div>
      <button class="cb" id="btnHandles" onclick="toggleHandles()">‚óÜ Handles</button>
      <button class="cb" onclick="autoLayout()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h10M4 18h6"/></svg> Layout
      </button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DIAGRAM SCHEMAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SCHEMAS = {
  hubspoke: {
    label: 'Hub-Spoke',
    addLabel: 'Add Spoke',
    schema: {
      center: "Product Hub",
      left: ["Auth Service","Billing","Analytics","Support"],
      right: ["Inventory","CRM","Marketing","Payments","Notifications"],
      style: { centerRadius:80, nodeWidth:150, nodeHeight:44, leftOffset:290, rightOffset:290, verticalSpread:95 }
    }
  },
  flowchart: {
    label: 'Flowchart',
    addLabel: 'Add Step',
    schema: {
      nodes: [
        { id:"n1", label:"Start",    shape:"oval",        x:400, y:60  },
        { id:"n2", label:"Input Data",shape:"parallelogram",x:400,y:170},
        { id:"n3", label:"Process",  shape:"rect",        x:400, y:280 },
        { id:"n4", label:"Valid?",   shape:"diamond",     x:400, y:400 },
        { id:"n5", label:"Output",   shape:"parallelogram",x:400,y:520 },
        { id:"n6", label:"Error Log",shape:"rect",        x:220, y:400 },
        { id:"n7", label:"End",      shape:"oval",        x:400, y:630 }
      ],
      edges: [
        { from:"n1",to:"n2",label:""         },
        { from:"n2",to:"n3",label:""         },
        { from:"n3",to:"n4",label:""         },
        { from:"n4",to:"n5",label:"Yes"      },
        { from:"n4",to:"n6",label:"No"       },
        { from:"n6",to:"n3",label:"Retry"    },
        { from:"n5",to:"n7",label:""         }
      ]
    }
  },
  mindmap: {
    label: 'Mind Map',
    addLabel: 'Add Branch',
    schema: {
      root: "Design System",
      branches: [
        { label:"Typography", children:["Fonts","Scale","Line Height"] },
        { label:"Color", children:["Palette","Dark Mode","Contrast"] },
        { label:"Components", children:["Buttons","Cards","Modals"] },
        { label:"Layout", children:["Grid","Spacing","Breakpoints"] },
        { label:"Motion", children:["Easing","Duration","Patterns"] }
      ]
    }
  },
  orgchart: {
    label: 'Org Chart',
    addLabel: 'Add Report',
    schema: {
      nodes: [
        { id:"ceo", label:"CEO",      role:"Executive",         x:400, y:50,  parent:null  },
        { id:"cto", label:"CTO",      role:"Engineering",       x:200, y:180, parent:"ceo" },
        { id:"cmo", label:"CMO",      role:"Marketing",         x:400, y:180, parent:"ceo" },
        { id:"cfo", label:"CFO",      role:"Finance",           x:600, y:180, parent:"ceo" },
        { id:"e1",  label:"VP Eng",   role:"Backend",           x:100, y:320, parent:"cto" },
        { id:"e2",  label:"VP Product",role:"Product",          x:280, y:320, parent:"cto" },
        { id:"m1",  label:"Growth",   role:"Growth Marketing",  x:400, y:320, parent:"cmo" },
        { id:"f1",  label:"Controller",role:"Accounting",       x:560, y:320, parent:"cfo" },
        { id:"f2",  label:"FP&A",     role:"Planning",          x:700, y:320, parent:"cfo" }
      ]
    }
  },
  sequence: {
    label: 'Sequence',
    addLabel: 'Add Message',
    schema: {
      actors: ["Client","API Gateway","Auth Service","Database"],
      messages: [
        { from:0, to:1, label:"POST /login",    type:"solid"  },
        { from:1, to:2, label:"Verify token",   type:"solid"  },
        { from:2, to:3, label:"Lookup user",    type:"solid"  },
        { from:3, to:2, label:"User record",    type:"dashed" },
        { from:2, to:1, label:"Token valid",    type:"dashed" },
        { from:1, to:0, label:"200 OK + JWT",   type:"dashed" },
        { from:0, to:1, label:"GET /resource",  type:"solid"  },
        { from:1, to:3, label:"Query data",     type:"solid"  },
        { from:3, to:1, label:"Result set",     type:"dashed" },
        { from:1, to:0, label:"200 OK + data",  type:"dashed" }
      ]
    }
  },
  er: {
    label: 'ER Diagram',
    addLabel: 'Add Entity',
    schema: {
      entities: [
        {
          id:"users", label:"users", x:120, y:150,
          fields:[
            { name:"id",         type:"PK" },
            { name:"email",      type:"field" },
            { name:"created_at", type:"field" }
          ]
        },
        {
          id:"orders", label:"orders", x:420, y:100,
          fields:[
            { name:"id",         type:"PK" },
            { name:"user_id",    type:"FK" },
            { name:"total",      type:"field" },
            { name:"status",     type:"field" }
          ]
        },
        {
          id:"products", label:"products", x:700, y:150,
          fields:[
            { name:"id",         type:"PK" },
            { name:"name",       type:"field" },
            { name:"price",      type:"field" },
            { name:"stock",      type:"field" }
          ]
        },
        {
          id:"order_items", label:"order_items", x:420, y:380,
          fields:[
            { name:"id",         type:"PK" },
            { name:"order_id",   type:"FK" },
            { name:"product_id", type:"FK" },
            { name:"quantity",   type:"field" }
          ]
        }
      ],
      relations: [
        { from:"users",   to:"orders",      label:"places",  card:"1:N" },
        { from:"orders",  to:"order_items", label:"has",     card:"1:N" },
        { from:"products",to:"order_items", label:"in",      card:"N:M" }
      ]
    }
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentType = 'hubspoke';
let currentData = JSON.parse(JSON.stringify(SCHEMAS.hubspoke.schema));

// Node/edge visual state
let vnodes = []; // { id, x, y, label, shape, color, data, w, h }
let vedges = []; // { id, fromId, toId, cpOffX, cpOffY, label, style }
let idCtr = 0;

let viewX = 0, viewY = 0, viewScale = 1;
let dragState = null;
let mode = 'select';
let showHandles = false;
let selectedId = null;
let spaceDown = false;

let editor;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MONACO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
require.config({ paths: { vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.51.0/min/vs' }});
require(['vs/editor/editor.main'], () => {
  editor = monaco.editor.create(document.getElementById('monaco-editor'), {
    value: JSON.stringify(currentData, null, 2),
    language: 'json',
    theme: 'vs-dark',
    automaticLayout: true,
    minimap: { enabled: false },
    fontSize: 12.5,
    fontFamily: "'DM Mono', monospace",
    lineNumbers: 'on',
    scrollBeyondLastLine: false,
    smoothScrolling: true,
    padding: { top: 10 }
  });
  editor.onDidChangeModelContent(() => {
    clearTimeout(window._rt);
    window._rt = setTimeout(loadFromEditor, 420);
  });
  buildDiagram(currentType, currentData);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DIAGRAM TYPE SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchDiagramType(type) {
  currentType = type;
  currentData = JSON.parse(JSON.stringify(SCHEMAS[type].schema));
  document.querySelectorAll('.type-tab').forEach(t => t.classList.toggle('active', t.dataset.type === type));
  document.getElementById('addNodeLabel').textContent = SCHEMAS[type].addLabel;

  // Reset view
  viewX = 0; viewY = 0; viewScale = 1;
  selectedId = null;
  closeDp();

  if (editor) editor.setValue(JSON.stringify(currentData, null, 2));
  buildDiagram(type, currentData);
  showToast(`Switched to ${SCHEMAS[type].label}`);
}

function loadFromEditor() {
  if (!editor) return;
  try {
    const d = JSON.parse(editor.getValue());
    currentData = d;
    buildDiagram(currentType, d);
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUILD DIAGRAM ‚Üí vnodes/vedges
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildDiagram(type, data) {
  vnodes = []; vedges = []; idCtr = 0;

  const fn = {
    hubspoke: buildHubSpoke,
    flowchart: buildFlowchart,
    mindmap: buildMindMap,
    orgchart: buildOrgChart,
    sequence: buildSequence,
    er: buildER
  }[type];

  if (fn) fn(data);
  render();
}

// ‚îÄ‚îÄ‚îÄ Hub-Spoke ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildHubSpoke(d) {
  const s = d.style || {};
  const cx=500, cy=380;
  const cr = s.centerRadius||80, nw=s.nodeWidth||150, nh=s.nodeHeight||44;
  const lo=s.leftOffset||290, ro=s.rightOffset||290, vs=s.verticalSpread||95;

  const cid = uid();
  vnodes.push({ id:cid, x:cx, y:cy, label:d.center||'Center', shape:'circle', color:null, w:cr*2, h:cr*2, r:cr, side:'center' });

  (d.left||[]).forEach((lbl,i) => {
    const y = cy + (i-(d.left.length-1)/2)*vs;
    const nid = uid();
    vnodes.push({ id:nid, x:cx-lo, y, label:lbl, shape:'rect', color:null, w:nw, h:nh, side:'left' });
    vedges.push({ id:uid(), fromId:cid, toId:nid, cpOffX:0, cpOffY:0, label:'', style:'curve' });
  });

  (d.right||[]).forEach((lbl,i) => {
    const y = cy + (i-(d.right.length-1)/2)*vs;
    const nid = uid();
    vnodes.push({ id:nid, x:cx+ro, y, label:lbl, shape:'rect', color:null, w:nw, h:nh, side:'right' });
    vedges.push({ id:uid(), fromId:cid, toId:nid, cpOffX:0, cpOffY:0, label:'', style:'curve' });
  });
}

// ‚îÄ‚îÄ‚îÄ Flowchart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildFlowchart(d) {
  const nodeMap = {};
  (d.nodes||[]).forEach(n => {
    const vn = { id:n.id||uid(), x:n.x||200, y:n.y||200, label:n.label||'Step',
                 shape:n.shape||'rect', color:n.color||null, w:150, h:50 };
    nodeMap[n.id] = vn;
    vnodes.push(vn);
  });
  (d.edges||[]).forEach(e => {
    vedges.push({ id:uid(), fromId:e.from, toId:e.to, cpOffX:0, cpOffY:0,
                  label:e.label||'', style:'arrow' });
  });
}

// ‚îÄ‚îÄ‚îÄ Mind Map ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildMindMap(d) {
  const cx=480, cy=360;
  const rid = uid();
  vnodes.push({ id:rid, x:cx, y:cy, label:d.root||'Root', shape:'oval', color:null, w:160, h:52, side:'root' });

  const branches = d.branches||[];
  const total = branches.length;
  branches.forEach((br, bi) => {
    const angle = (bi / total) * Math.PI * 2 - Math.PI/2;
    const bx = cx + Math.cos(angle) * 230;
    const by = cy + Math.sin(angle) * 180;
    const bid = uid();
    vnodes.push({ id:bid, x:bx, y:by, label:br.label, shape:'rect', color:null, w:130, h:40, side:'branch' });
    vedges.push({ id:uid(), fromId:rid, toId:bid, cpOffX:0, cpOffY:0, label:'', style:'curve' });

    const children = br.children||[];
    children.forEach((ch, ci) => {
      const spread = (children.length-1)*30;
      const perp = (ci-(children.length-1)/2)*60;
      const perpX = -Math.sin(angle)*perp;
      const perpY = Math.cos(angle)*perp;
      const cchx = bx + Math.cos(angle)*160 + perpX;
      const cchy = by + Math.sin(angle)*130 + perpY;
      const cid = uid();
      vnodes.push({ id:cid, x:cchx, y:cchy, label:ch, shape:'rect', color:null, w:120, h:36, side:'leaf' });
      vedges.push({ id:uid(), fromId:bid, toId:cid, cpOffX:0, cpOffY:0, label:'', style:'smooth' });
    });
  });
}

// ‚îÄ‚îÄ‚îÄ Org Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildOrgChart(d) {
  (d.nodes||[]).forEach(n => {
    vnodes.push({ id:n.id, x:n.x||200, y:n.y||100, label:n.label, sublabel:n.role||'',
                  shape:'orgbox', color:n.color||null, w:150, h:54, parent:n.parent });
  });
  vnodes.forEach(n => {
    if (n.parent) {
      vedges.push({ id:uid(), fromId:n.parent, toId:n.id, cpOffX:0, cpOffY:0, label:'', style:'elbow' });
    }
  });
}

// ‚îÄ‚îÄ‚îÄ Sequence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildSequence(d) {
  // Actors as special nodes
  const actors = d.actors||[];
  const messages = d.messages||[];
  const spacing = 180;
  const startX = 160;
  const actorY = 60;
  const msgStep = 70;

  actors.forEach((a, i) => {
    vnodes.push({ id:'actor_'+i, x:startX+i*spacing, y:actorY, label:a,
                  shape:'seqactor', color:null, w:120, h:44, actorIdx:i });
  });

  messages.forEach((m, mi) => {
    const y = actorY + 80 + mi * msgStep;
    vedges.push({
      id:uid(), fromId:'actor_'+m.from, toId:'actor_'+m.to,
      cpOffX:0, cpOffY:0, label:m.label||'', style:'seq',
      seqY: y, seqType: m.type||'solid'
    });
  });
}

// ‚îÄ‚îÄ‚îÄ ER Diagram ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildER(d) {
  const entityMap = {};
  (d.entities||[]).forEach(e => {
    const rowH = 28, headerH = 36;
    const h = headerH + (e.fields||[]).length * rowH;
    const vn = { id:e.id, x:e.x||200, y:e.y||200, label:e.label,
                 shape:'er', color:null, w:200, h, fields:e.fields||[] };
    entityMap[e.id] = vn;
    vnodes.push(vn);
  });
  (d.relations||[]).forEach(r => {
    vedges.push({ id:uid(), fromId:r.from, toId:r.to,
                  cpOffX:0, cpOffY:0, label:r.label+(r.card?' ('+r.card+')':''), style:'arrow' });
  });
}

function uid() { return 'n'+(idCtr++); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() {
  const g = document.getElementById('canvas-group');
  g.innerHTML = '';
  g.setAttribute('transform', `translate(${viewX},${viewY}) scale(${viewScale})`);

  const cs = getComputedStyle(document.body);
  const clr = k => cs.getPropertyValue(k).trim();
  const colors = {
    accent:     clr('--accent'),
    accent2:    clr('--accent2'),
    nodeFill:   clr('--node-fill'),
    nodeStroke: clr('--node-stroke'),
    nodeText:   clr('--node-text'),
    centerFill: clr('--center-fill'),
    centerText: clr('--center-text'),
    conn:       clr('--conn'),
    connHi:     clr('--conn-hi'),
    bg:         clr('--bg'),
    bg2:        clr('--bg2'),
    bg3:        clr('--bg3'),
    border:     clr('--border'),
    textMuted:  clr('--text-muted'),
    shapeA:     clr('--shape-a'),
    shapeB:     clr('--shape-b'),
    shapeC:     clr('--shape-c'),
    shapeD:     clr('--shape-d'),
  };

  // Sequence lifelines
  if (currentType === 'sequence') renderSequenceLifelines(g, colors);

  // Edges
  vedges.forEach(e => renderEdge(g, e, colors));

  // Nodes
  vnodes.forEach(n => renderNode(g, n, colors));
}

// ‚îÄ‚îÄ‚îÄ Lifelines for sequence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSequenceLifelines(g, c) {
  const actors = vnodes.filter(n => n.shape === 'seqactor');
  const maxY = vedges.reduce((m,e) => e.seqY ? Math.max(m,e.seqY+40) : m, 200);
  actors.forEach(a => {
    const line = svgEl('line', {
      x1:a.x, y1:a.y+a.h/2+4, x2:a.x, y2:maxY+20,
      stroke:c.conn, 'stroke-width':1.5, 'stroke-dasharray':'6,4'
    });
    g.appendChild(line);
  });
}

// ‚îÄ‚îÄ‚îÄ Edge rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEdge(g, e, c) {
  const from = vnodes.find(n => n.id === e.fromId);
  const to   = vnodes.find(n => n.id === e.toId);
  if (!from || !to) return;

  const sel = selectedId === e.fromId || selectedId === e.toId;
  const stroke = sel ? c.connHi : c.conn;
  const sw = sel ? 2.2 : 1.6;

  if (e.style === 'seq') {
    // Sequence message
    const y = e.seqY;
    const isDashed = e.seqType === 'dashed' || e.seqType === 'return';
    const isReturn = e.seqType === 'return';
    const x1 = from.x, x2 = to.x;

    const path = svgEl('line', {
      x1, y1:y, x2, y2:y,
      stroke, 'stroke-width':sw,
      'stroke-dasharray': isDashed ? '7,4' : 'none',
      'marker-end': 'url(#arrow)'
    });
    g.appendChild(path);

    if (e.label) {
      const tx = (x1+x2)/2;
      const txt = svgEl('text', { x:tx, y:y-8, fill:c.textMuted, 'text-anchor':'middle',
        'font-size':11, 'font-family':"'DM Mono',monospace" });
      txt.textContent = e.label;
      g.appendChild(txt);
    }
    return;
  }

  if (e.style === 'elbow') {
    // Org chart elbow connector
    const midY = (from.y + to.y) / 2;
    const d = `M${from.x},${from.y+from.h/2} L${from.x},${midY} L${to.x},${midY} L${to.x},${to.y-to.h/2}`;
    g.appendChild(svgEl('path', { d, fill:'none', stroke, 'stroke-width':sw, 'stroke-linecap':'round', 'stroke-linejoin':'round' }));
    return;
  }

  // Bezier / arrow
  const { x1, y1, x2, y2 } = edgeEndpoints(from, to);
  const mx = (x1+x2)/2 + e.cpOffX;
  const my = (y1+y2)/2 + e.cpOffY;
  const pd = `M${x1},${y1} Q${mx},${my} ${x2},${y2}`;
  const isDashed = e.style === 'smooth';
  const hasArrow = e.style === 'arrow';

  g.appendChild(svgEl('path', {
    d: pd, fill:'none', stroke, 'stroke-width':sw,
    'stroke-linecap':'round',
    'stroke-dasharray': isDashed ? '5,3' : 'none',
    'marker-end': hasArrow ? 'url(#arrow)' : 'none'
  }));

  if (e.label) {
    const t = svgEl('text', {
      x: mx, y: my-10, fill: c.textMuted,
      'text-anchor':'middle', 'font-size':11,
      'font-family':"'DM Mono',monospace"
    });
    t.textContent = e.label;
    g.appendChild(t);
  }

  // Control point handle
  if (showHandles && e.style !== 'elbow') {
    const h = svgEl('path', {
      d:`M${mx},${my-7} L${mx+7},${my} L${mx},${my+7} L${mx-7},${my} Z`,
      fill:c.accent, stroke:'white', 'stroke-width':1.5,
      style:'cursor:move;opacity:.85;'
    });
    h.addEventListener('mousedown', ev => startEdgeDrag(ev, e.id));
    h.addEventListener('touchstart', ev => startEdgeDrag(ev, e.id), { passive:false });
    g.appendChild(h);
  }
}

// ‚îÄ‚îÄ‚îÄ Node rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderNode(g, n, c) {
  const sel = n.id === selectedId;
  const fill  = n.color || (n.side==='center'||n.side==='root' ? c.centerFill : c.nodeFill);
  const stroke = sel ? c.accent : (n.side==='center'||n.side==='root' ? c.centerFill : c.nodeStroke);
  const textClr= (n.side==='center'||n.side==='root') ? c.centerText : c.nodeText;
  const sw = sel ? 2.5 : 1.5;
  const filter = sel ? 'url(#glow)' : '';

  const grp = svgEl('g', { style:'cursor:grab;' });

  const drawShape = () => {
    const { shape, x, y, w, h } = n;
    if (shape === 'circle') {
      const r = n.r || w/2;
      return svgEl('circle', { cx:x, cy:y, r, fill, stroke, 'stroke-width':sel?3:2.5, filter });
    }
    if (shape === 'oval' || shape === 'seqactor') {
      return svgEl('ellipse', { cx:x, cy:y, rx:w/2, ry:h/2, fill, stroke, 'stroke-width':sw, filter });
    }
    if (shape === 'diamond') {
      const pts = `${x},${y-h/1.4} ${x+w/1.4},${y} ${x},${y+h/1.4} ${x-w/1.4},${y}`;
      return svgEl('polygon', { points:pts, fill, stroke, 'stroke-width':sw, filter });
    }
    if (shape === 'parallelogram') {
      const sk = 18;
      const pts = `${x-w/2+sk},${y-h/2} ${x+w/2+sk},${y-h/2} ${x+w/2-sk},${y+h/2} ${x-w/2-sk},${y+h/2}`;
      return svgEl('polygon', { points:pts, fill, stroke, 'stroke-width':sw, filter });
    }
    if (shape === 'cylinder') {
      const ry = 8, rx = w/2;
      const g2 = svgEl('g', {});
      g2.appendChild(svgEl('rect', { x:x-rx, y:y-h/2+ry, width:w, height:h-ry*2, fill, stroke:'none' }));
      g2.appendChild(svgEl('ellipse', { cx:x, cy:y-h/2+ry, rx, ry, fill, stroke, 'stroke-width':sw }));
      g2.appendChild(svgEl('ellipse', { cx:x, cy:y+h/2-ry, rx, ry, fill, stroke, 'stroke-width':sw }));
      g2.appendChild(svgEl('rect', { x:x-rx, y:y-h/2+ry, width:w, height:h-ry*2, fill:'none', stroke, 'stroke-width':sw, filter }));
      return g2;
    }
    if (shape === 'er') {
      return renderERNode(n, c, sel);
    }
    if (shape === 'orgbox') {
      return renderOrgBox(n, c, sel);
    }
    // Default rect
    return svgEl('rect', { x:x-w/2, y:y-h/2, width:w, height:h, rx:9, ry:9, fill, stroke, 'stroke-width':sw, filter });
  };

  const shape = drawShape();
  if (shape.nodeName === 'g') {
    // complex shape ‚Äî append children
    Array.from(shape.children).forEach(ch => grp.appendChild(ch));
  } else {
    grp.appendChild(shape);
  }

  // Text (not for ER/Org which handle their own)
  if (n.shape !== 'er' && n.shape !== 'orgbox') {
    const txt = svgEl('text', {
      x:n.x, y:n.y, fill:textClr,
      'text-anchor':'middle', 'dominant-baseline':'middle',
      'font-size': n.side==='center'||n.side==='root' ? 20 : (n.side==='leaf'?12:14),
      'font-weight': n.side==='center'||n.side==='root' ? 700 : 500,
      'font-family': n.side==='center'||n.side==='root' ? "'Syne',sans-serif" : "'DM Sans',sans-serif",
      'pointer-events':'none'
    });
    txt.textContent = n.label;
    grp.appendChild(txt);

    if (n.sublabel) {
      const sub = svgEl('text', {
        x:n.x, y:n.y+16, fill:c.textMuted,
        'text-anchor':'middle', 'dominant-baseline':'middle',
        'font-size':10, 'font-family':"'DM Mono',monospace",
        'pointer-events':'none'
      });
      sub.textContent = n.sublabel;
      grp.appendChild(sub);
    }
  }

  grp.addEventListener('mousedown', ev => onNodeDown(ev, n.id));
  grp.addEventListener('touchstart', ev => onNodeDown(ev, n.id), { passive:false });
  grp.addEventListener('dblclick', () => {
    selectedId = n.id;
    showDp(n);
    setTimeout(() => { document.getElementById('dpLabel').focus(); document.getElementById('dpLabel').select(); }, 50);
  });

  g.appendChild(grp);
}

function renderERNode(n, c, sel) {
  const rowH = 28, headerH = 36;
  const x = n.x - n.w/2, y = n.y - n.h/2;
  const g2 = svgEl('g', {});

  // Background
  g2.appendChild(svgEl('rect', {
    x, y, width:n.w, height:n.h, rx:8,
    fill:c.nodeFill, stroke: sel ? c.accent : c.nodeStroke,
    'stroke-width': sel ? 2.2 : 1.5
  }));

  // Header
  g2.appendChild(svgEl('rect', {
    x, y, width:n.w, height:headerH, rx:8,
    fill:c.centerFill
  }));
  g2.appendChild(svgEl('rect', { x, y:y+headerH-4, width:n.w, height:4, fill:c.centerFill }));

  const hTxt = svgEl('text', {
    x:n.x, y:y+headerH/2, fill:c.centerText,
    'text-anchor':'middle','dominant-baseline':'middle',
    'font-size':13,'font-weight':700,'font-family':"'Syne',sans-serif",
    'pointer-events':'none'
  });
  hTxt.textContent = n.label;
  g2.appendChild(hTxt);

  // Fields
  (n.fields||[]).forEach((f, fi) => {
    const fy = y + headerH + fi*rowH;
    if (fi > 0) g2.appendChild(svgEl('line', {
      x1:x, y1:fy, x2:x+n.w, y2:fy,
      stroke:c.border, 'stroke-width':1
    }));

    const isPK = f.type === 'PK', isFK = f.type === 'FK';
    const badge = isPK ? c.shapeA : isFK ? c.shapeC : c.textMuted;

    if (f.type !== 'field') {
      const bg = svgEl('rect', {
        x:x+8, y:fy+5, width:22, height:16, rx:4,
        fill:badge, opacity:.2
      });
      g2.appendChild(bg);
      const bt = svgEl('text', {
        x:x+19, y:fy+rowH/2, fill:badge,
        'text-anchor':'middle','dominant-baseline':'middle',
        'font-size':8,'font-weight':700,'font-family':"'DM Mono',monospace",
        'pointer-events':'none'
      });
      bt.textContent = f.type;
      g2.appendChild(bt);
    }

    const ft = svgEl('text', {
      x:x+(f.type!=='field'?38:12), y:fy+rowH/2, fill:c.nodeText,
      'dominant-baseline':'middle','font-size':11.5,
      'font-family':"'DM Mono',monospace",'pointer-events':'none'
    });
    ft.textContent = f.name;
    g2.appendChild(ft);
  });

  return g2;
}

function renderOrgBox(n, c, sel) {
  const g2 = svgEl('g', {});
  const x = n.x - n.w/2, y = n.y - n.h/2;
  const accentBar = 4;

  g2.appendChild(svgEl('rect', {
    x, y, width:n.w, height:n.h, rx:8,
    fill:n.color||c.nodeFill,
    stroke: sel ? c.accent : c.nodeStroke,
    'stroke-width': sel ? 2.2 : 1.5
  }));

  // Accent left bar
  g2.appendChild(svgEl('rect', {
    x, y:y+8, width:accentBar, height:n.h-16, rx:2,
    fill:n.color ? lightenColor(n.color) : c.accent
  }));

  const nameT = svgEl('text', {
    x:n.x+3, y:n.y - (n.sublabel?7:0), fill:c.nodeText,
    'text-anchor':'middle','dominant-baseline':'middle',
    'font-size':13,'font-weight':600,'font-family':"'DM Sans',sans-serif",
    'pointer-events':'none'
  });
  nameT.textContent = n.label;
  g2.appendChild(nameT);

  if (n.sublabel) {
    const sub = svgEl('text', {
      x:n.x+3, y:n.y+10, fill:c.textMuted,
      'text-anchor':'middle','dominant-baseline':'middle',
      'font-size':10,'font-family':"'DM Mono',monospace",'pointer-events':'none'
    });
    sub.textContent = n.sublabel;
    g2.appendChild(sub);
  }

  return g2;
}

function lightenColor(hex) { return hex; } // placeholder

function svgEl(tag, attrs) {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
  return el;
}

function edgeEndpoints(from, to) {
  let x1=from.x, y1=from.y, x2=to.x, y2=to.y;

  if (from.shape==='circle') {
    const r = from.r||from.w/2;
    const dx=to.x-from.x, dy=to.y-from.y, d=Math.hypot(dx,dy)||1;
    x1=from.x+dx/d*r; y1=from.y+dy/d*r;
  } else if (from.shape==='oval'||from.shape==='seqactor') {
    const dx=to.x-from.x, dy=to.y-from.y;
    const d=Math.hypot(dx,dy)||1;
    x1=from.x+dx/d*(from.w/2); y1=from.y+dy/d*(from.h/2);
  }

  if (to.shape==='circle') {
    const r = to.r||to.w/2;
    const dx=from.x-to.x, dy=from.y-to.y, d=Math.hypot(dx,dy)||1;
    x2=to.x+dx/d*r; y2=to.y+dy/d*r;
  } else if (to.shape==='oval'||to.shape==='seqactor') {
    const dx=from.x-to.x, dy=from.y-to.y;
    const d=Math.hypot(dx,dy)||1;
    x2=to.x+dx/d*(to.w/2); y2=to.y+dy/d*(to.h/2);
  } else if (to.shape==='diamond') {
    const hw=to.w/1.4, hh=to.h/1.4;
    x2=to.x-(from.x>to.x?-hw:hw); y2=to.y;
  } else if (to.shape==='er'||to.shape==='orgbox') {
    x2=to.x+(from.x>to.x?to.w/2:-to.w/2); y2=to.y;
  } else {
    const side = to.x > from.x ? -to.w/2 : to.w/2;
    x2=to.x+side; y2=to.y;
  }

  return { x1, y1, x2, y2 };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CANVAS INTERACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', () => {
  const svg = document.getElementById('diagram-svg');
  svg.addEventListener('mousedown', onCanvasDown);
  svg.addEventListener('touchstart', onCanvasDown, { passive:false });
  document.addEventListener('mousemove', onMove);
  document.addEventListener('touchmove', onMove, { passive:false });
  document.addEventListener('mouseup', onUp);
  document.addEventListener('touchend', onUp);
  svg.addEventListener('wheel', onWheel, { passive:false });

  document.addEventListener('keydown', e => {
    if (e.code==='Space'&&!e.target.matches('input,textarea,select')) { spaceDown=true; svg.style.cursor='grab'; }
    if ((e.key==='Delete'||e.key==='Backspace')&&selectedId!==null&&!e.target.matches('input,textarea,select')) deleteSelected();
  });
  document.addEventListener('keyup', e => {
    if (e.code==='Space') { spaceDown=false; svg.style.cursor='default'; }
  });
});

function svgPoint(e) {
  const svg = document.getElementById('diagram-svg');
  const r = svg.getBoundingClientRect();
  const ev = e.touches ? e.touches[0] : e;
  return {
    x: (ev.clientX - r.left - viewX) / viewScale,
    y: (ev.clientY - r.top  - viewY) / viewScale,
    rawX: ev.clientX - r.left,
    rawY: ev.clientY - r.top
  };
}

function onCanvasDown(e) {
  const tgt = e.target;
  if (tgt === document.getElementById('diagram-svg') || tgt === document.getElementById('canvas-group')) {
    if (mode==='pan'||spaceDown) {
      const ev = e.touches?e.touches[0]:e;
      dragState = { type:'pan', sx:ev.clientX, sy:ev.clientY, svx:viewX, svy:viewY };
    } else {
      selectedId = null; closeDp(); render();
    }
  }
}

function onNodeDown(e, id) {
  if (e.button===2) return;
  e.preventDefault(); e.stopPropagation();
  if (mode==='pan'||spaceDown) {
    const ev=e.touches?e.touches[0]:e;
    dragState={type:'pan',sx:ev.clientX,sy:ev.clientY,svx:viewX,svy:viewY};
    return;
  }
  const n = vnodes.find(v=>v.id===id);
  if (!n) return;
  selectedId = id;
  const pt = svgPoint(e);
  dragState = { type:'node', id, sx:pt.x, sy:pt.y, ox:n.x, oy:n.y };
  showDp(n);
  render();
}

function startEdgeDrag(e, eid) {
  e.preventDefault(); e.stopPropagation();
  const ed = vedges.find(v=>v.id===eid);
  if (!ed) return;
  const pt = svgPoint(e);
  dragState = { type:'edge', id:eid, sx:pt.x, sy:pt.y, ocx:ed.cpOffX, ocy:ed.cpOffY };
}

function onMove(e) {
  if (!dragState) return;
  e.preventDefault();
  const ev = e.touches?e.touches[0]:e;

  if (dragState.type==='pan') {
    viewX = dragState.svx+(ev.clientX-dragState.sx);
    viewY = dragState.svy+(ev.clientY-dragState.sy);
    document.getElementById('canvas-group').setAttribute('transform',`translate(${viewX},${viewY}) scale(${viewScale})`);
    return;
  }
  if (dragState.type==='node') {
    const pt=svgPoint(e);
    const n=vnodes.find(v=>v.id===dragState.id);
    if (n) { n.x=dragState.ox+(pt.x-dragState.sx); n.y=dragState.oy+(pt.y-dragState.sy); render(); }
    return;
  }
  if (dragState.type==='edge') {
    const pt=svgPoint(e);
    const ed=vedges.find(v=>v.id===dragState.id);
    if (ed) { ed.cpOffX=dragState.ocx+(pt.x-dragState.sx); ed.cpOffY=dragState.ocy+(pt.y-dragState.sy); render(); }
  }
}

function onUp() {
  if (dragState) syncEditorFromCanvas();
  dragState = null;
}

function onWheel(e) {
  e.preventDefault();
  const r=document.getElementById('diagram-svg').getBoundingClientRect();
  const mx=e.clientX-r.left, my=e.clientY-r.top;
  const f=e.deltaY>0?0.9:1.1;
  const ns=Math.max(.1,Math.min(4,viewScale*f));
  viewX=mx-(mx-viewX)*(ns/viewScale);
  viewY=my-(my-viewY)*(ns/viewScale);
  viewScale=ns;
  document.getElementById('canvas-group').setAttribute('transform',`translate(${viewX},${viewY}) scale(${viewScale})`);
  document.getElementById('zoomBadge').textContent=Math.round(viewScale*100)+'%';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NODE OPERATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function diagramAddNode() {
  const type = currentType;
  if (type==='hubspoke') {
    const center = vnodes.find(n=>n.side==='center');
    const s = currentData.style||{};
    const ro = s.rightOffset||290, vs = s.verticalSpread||95;
    const rights = vnodes.filter(n=>n.side==='right');
    const y = (center?.y||380) + rights.length*vs - rights.length/2*vs;
    const nid = uid();
    vnodes.push({ id:nid, x:(center?.x||500)+ro, y, label:'New Node', shape:'rect', color:null, w:s.nodeWidth||150, h:s.nodeHeight||44, side:'right' });
    vedges.push({ id:uid(), fromId:center?.id||'n0', toId:nid, cpOffX:0, cpOffY:0, label:'', style:'curve' });
  } else if (type==='flowchart') {
    const last = vnodes[vnodes.length-1];
    const nid = uid();
    const nx = last ? last.x : 400, ny = last ? last.y+120 : 60;
    vnodes.push({ id:nid, x:nx, y:ny, label:'New Step', shape:'rect', color:null, w:150, h:50 });
    if (last) vedges.push({ id:uid(), fromId:last.id, toId:nid, cpOffX:0, cpOffY:0, label:'', style:'arrow' });
  } else if (type==='mindmap') {
    const root = vnodes.find(n=>n.side==='root');
    const nid = uid();
    const angle = Math.random()*Math.PI*2;
    const bx=(root?.x||480)+Math.cos(angle)*230, by=(root?.y||360)+Math.sin(angle)*180;
    vnodes.push({ id:nid, x:bx, y:by, label:'New Branch', shape:'rect', color:null, w:130, h:40, side:'branch' });
    vedges.push({ id:uid(), fromId:root?.id||'n0', toId:nid, cpOffX:0, cpOffY:0, label:'', style:'curve' });
  } else if (type==='orgchart') {
    const last = vnodes[vnodes.length-1];
    const nid = uid();
    vnodes.push({ id:nid, x:(last?.x||400)+170, y:(last?.y||50)+140, label:'New Role', sublabel:'Team', shape:'orgbox', color:null, w:150, h:54, parent:last?.id });
    if (last) vedges.push({ id:uid(), fromId:last.id, toId:nid, cpOffX:0, cpOffY:0, label:'', style:'elbow' });
  } else if (type==='sequence') {
    const actors=vnodes.filter(n=>n.shape==='seqactor');
    if (!actors.length) return;
    const msgs=vedges.filter(e=>e.style==='seq');
    const lastY=msgs.length ? Math.max(...msgs.map(m=>m.seqY))+70 : 140;
    const from=actors[0].actorIdx, to=actors.length>1?actors[1].actorIdx:0;
    vedges.push({ id:uid(), fromId:'actor_'+from, toId:'actor_'+to, cpOffX:0, cpOffY:0,
                  label:'New Message', style:'seq', seqY:lastY, seqType:'solid' });
  } else if (type==='er') {
    const nid='e'+uid();
    vnodes.push({ id:nid, x:300+vnodes.length*40, y:300+vnodes.length*10,
                  label:'new_entity', shape:'er', color:null, w:200, h:36+28*2,
                  fields:[{name:'id',type:'PK'},{name:'name',type:'field'}] });
  }

  selectedId = vnodes[vnodes.length-1]?.id;
  render();
  syncEditorFromCanvas();
  showToast('Node added');
}

function deleteSelected() {
  if (selectedId===null) return;
  const n=vnodes.find(v=>v.id===selectedId);
  if (n && (n.side==='center'||n.side==='root'||n.shape==='seqactor')) {
    showToast('Cannot delete this node'); return;
  }
  vnodes=vnodes.filter(v=>v.id!==selectedId);
  vedges=vedges.filter(e=>e.fromId!==selectedId&&e.toId!==selectedId);
  selectedId=null; closeDp(); render(); syncEditorFromCanvas();
  showToast('Deleted');
}

function updateNodeLabel(v) {
  if (selectedId===null) return;
  const n=vnodes.find(nd=>nd.id===selectedId);
  if (n) { n.label=v; render(); }
  clearTimeout(window._st);
  window._st=setTimeout(syncEditorFromCanvas,600);
}

function updateNodeShape(v) {
  if (selectedId===null) return;
  const n=vnodes.find(nd=>nd.id===selectedId);
  if (n) { n.shape=v; render(); }
}

function updateNodeColor(v) {
  if (selectedId===null) return;
  const n=vnodes.find(nd=>nd.id===selectedId);
  if (n) { n.color=v; render(); }
}

function resetNodeColor() {
  if (selectedId===null) return;
  const n=vnodes.find(nd=>nd.id===selectedId);
  if (n) { n.color=null; render(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DETAIL PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showDp(n) {
  const p=document.getElementById('detailPanel');
  p.classList.add('show');
  document.getElementById('dpTitle').textContent = n.label||'Node';
  document.getElementById('dpLabel').value = n.label||'';
  document.getElementById('dpShape').value = n.shape||'rect';
  document.getElementById('dpColor').value = n.color||'#5b6ef5';
}
function closeDp() { document.getElementById('detailPanel').classList.remove('show'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYNC CANVAS ‚Üí EDITOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function syncEditorFromCanvas() {
  if (!editor) return;
  let out;
  const type = currentType;

  if (type==='hubspoke') {
    const c=vnodes.find(n=>n.side==='center');
    out = {
      ...currentData,
      center: c?.label||'Center',
      left: vnodes.filter(n=>n.side==='left').map(n=>n.label),
      right: vnodes.filter(n=>n.side==='right').map(n=>n.label),
    };
  } else if (type==='flowchart') {
    out = {
      nodes: vnodes.map(n=>({ id:n.id, label:n.label, shape:n.shape, x:Math.round(n.x), y:Math.round(n.y) })),
      edges: vedges.map(e=>({ from:e.fromId, to:e.toId, label:e.label||'' }))
    };
  } else if (type==='orgchart') {
    out = {
      nodes: vnodes.map(n=>({ id:n.id, label:n.label, role:n.sublabel||'', x:Math.round(n.x), y:Math.round(n.y), parent:n.parent||null }))
    };
  } else if (type==='mindmap') {
    const root=vnodes.find(n=>n.side==='root');
    const branches=vnodes.filter(n=>n.side==='branch');
    out = {
      root: root?.label||'Root',
      branches: branches.map(b => ({
        label: b.label,
        children: vnodes.filter(n=>n.side==='leaf'&&vedges.some(e=>e.fromId===b.id&&e.toId===n.id)).map(n=>n.label)
      }))
    };
  } else {
    out = currentData;
  }

  const s = JSON.stringify(out, null, 2);
  if (s !== editor.getValue()) editor.setValue(s);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CANVAS CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMode(m) {
  mode=m;
  document.getElementById('btnSelect').classList.toggle('active',m==='select');
  document.getElementById('btnPan').classList.toggle('active',m==='pan');
  document.getElementById('diagram-svg').style.cursor=m==='pan'?'grab':'default';
}

function zoomIn()  { applyZoom(1.2); }
function zoomOut() { applyZoom(0.82); }

function applyZoom(f) {
  const p=document.getElementById('canvasPane');
  const cx=p.clientWidth/2, cy=p.clientHeight/2;
  const ns=Math.max(.1,Math.min(4,viewScale*f));
  viewX=cx-(cx-viewX)*(ns/viewScale);
  viewY=cy-(cy-viewY)*(ns/viewScale);
  viewScale=ns;
  document.getElementById('canvas-group').setAttribute('transform',`translate(${viewX},${viewY}) scale(${viewScale})`);
  document.getElementById('zoomBadge').textContent=Math.round(viewScale*100)+'%';
}

function resetView() {
  // Fit all content
  if (!vnodes.length) return;
  const xs=vnodes.map(n=>n.x), ys=vnodes.map(n=>n.y);
  const minX=Math.min(...xs)-100, maxX=Math.max(...xs)+100;
  const minY=Math.min(...ys)-80, maxY=Math.max(...ys)+80;
  const p=document.getElementById('canvasPane');
  const fw=p.clientWidth, fh=p.clientHeight;
  const sx=(maxX-minX), sy=(maxY-minY);
  viewScale=Math.min(fw/sx, fh/sy, 1.5);
  viewX=(fw-sx*viewScale)/2 - minX*viewScale;
  viewY=(fh-sy*viewScale)/2 - minY*viewScale;
  document.getElementById('canvas-group').setAttribute('transform',`translate(${viewX},${viewY}) scale(${viewScale})`);
  document.getElementById('zoomBadge').textContent=Math.round(viewScale*100)+'%';
}

function toggleHandles() {
  showHandles=!showHandles;
  document.getElementById('btnHandles').classList.toggle('active',showHandles);
  render();
  showToast(showHandles?'Handles ON':'Handles OFF');
}

function autoLayout() {
  buildDiagram(currentType, currentData);
  showToast('Layout reset');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THEME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTheme(name) {
  const map={cosmic:'dark',arctic:'arctic',ember:'ember',forest:'forest',rose:'rose'};
  document.body.dataset.theme = map[name]||name;
  if (editor) editor.updateOptions({ theme:(name==='arctic'||name==='rose')?'vs':'vs-dark' });
  // Update arrow marker colors
  setTimeout(render, 30);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMPORT / EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function uploadFile() {
  const inp=document.createElement('input');
  inp.type='file'; inp.accept='.json';
  inp.onchange=e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{ try{ const d=JSON.parse(r.result); currentData=d; if(editor)editor.setValue(JSON.stringify(d,null,2)); buildDiagram(currentType,d); showToast('Imported!'); }catch{ showToast('Invalid JSON'); }};
    r.readAsText(f);
  };
  inp.click();
}

function downloadJSON() {
  const s=editor?editor.getValue():JSON.stringify(currentData,null,2);
  blob('diagram.json',s,'application/json');
  showToast('JSON downloaded');
}

function exportSVG() {
  const svg=document.getElementById('diagram-svg');
  const g=document.getElementById('canvas-group');
  const bb=g.getBBox(); const pad=50;
  const w=bb.width+pad*2, h=bb.height+pad*2;
  const cs=getComputedStyle(document.body);
  const bg=cs.getPropertyValue('--bg').trim();

  const clone=svg.cloneNode(true);
  clone.setAttribute('width',w); clone.setAttribute('height',h);
  clone.setAttribute('viewBox',`${bb.x-pad} ${bb.y-pad} ${w} ${h}`);
  const cg=clone.querySelector('#canvas-group');
  if(cg) cg.removeAttribute('transform');
  clone.querySelectorAll('.edge-handle').forEach(el=>el.remove());

  const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
  rect.setAttribute('x',bb.x-pad); rect.setAttribute('y',bb.y-pad);
  rect.setAttribute('width',w); rect.setAttribute('height',h);
  rect.setAttribute('fill',bg);
  clone.insertBefore(rect,clone.querySelector('defs').nextSibling);

  // Inline CSS vars
  const style=document.createElementNS('http://www.w3.org/2000/svg','style');
  const vars=[...document.querySelectorAll('[data-theme]')].reduce((_,el)=>'','')+
    Object.entries({ '--accent':cs.getPropertyValue('--accent').trim(),
      '--conn':cs.getPropertyValue('--conn').trim(), '--conn-hi':cs.getPropertyValue('--conn-hi').trim(),
      '--node-fill':cs.getPropertyValue('--node-fill').trim(), '--node-stroke':cs.getPropertyValue('--node-stroke').trim(),
      '--node-text':cs.getPropertyValue('--node-text').trim(), '--center-fill':cs.getPropertyValue('--center-fill').trim(),
      '--center-text':cs.getPropertyValue('--center-text').trim(), '--text-muted':cs.getPropertyValue('--text-muted').trim(),
      '--bg':bg,'--bg2':cs.getPropertyValue('--bg2').trim(),'--border':cs.getPropertyValue('--border').trim(),
      '--shape-a':cs.getPropertyValue('--shape-a').trim(),'--shape-c':cs.getPropertyValue('--shape-c').trim()
    }).map(([k,v])=>`${k}:${v}`).join(';');
  style.textContent=`:root{${vars}}@import url('https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500&family=DM+Mono:wght@400&display=swap');`;
  clone.querySelector('defs').appendChild(style);

  blob('diagram.svg',new XMLSerializer().serializeToString(clone),'image/svg+xml');
  showToast('SVG exported');
}

async function exportPNG() {
  const svg=document.getElementById('diagram-svg');
  const g=document.getElementById('canvas-group');
  const bb=g.getBBox(); const pad=50; const scale=2;
  const cs=getComputedStyle(document.body);
  const bg=cs.getPropertyValue('--bg').trim();
  const W=(bb.width+pad*2)*scale, H=(bb.height+pad*2)*scale;

  const clone=svg.cloneNode(true);
  clone.setAttribute('width',W); clone.setAttribute('height',H);
  clone.setAttribute('viewBox',`${bb.x-pad} ${bb.y-pad} ${bb.width+pad*2} ${bb.height+pad*2}`);
  const cg=clone.querySelector('#canvas-group'); if(cg)cg.removeAttribute('transform');
  clone.querySelectorAll('.edge-handle').forEach(el=>el.remove());

  // Inline CSS variables into SVG
  const style=document.createElementNS('http://www.w3.org/2000/svg','style');
  style.textContent=`:root{--accent:${cs.getPropertyValue('--accent').trim()};--conn:${cs.getPropertyValue('--conn').trim()};--conn-hi:${cs.getPropertyValue('--conn-hi').trim()};--node-fill:${cs.getPropertyValue('--node-fill').trim()};--node-stroke:${cs.getPropertyValue('--node-stroke').trim()};--node-text:${cs.getPropertyValue('--node-text').trim()};--center-fill:${cs.getPropertyValue('--center-fill').trim()};--center-text:${cs.getPropertyValue('--center-text').trim()};--text-muted:${cs.getPropertyValue('--text-muted').trim()};--bg:${bg};--bg2:${cs.getPropertyValue('--bg2').trim()};--border:${cs.getPropertyValue('--border').trim()};--shape-a:${cs.getPropertyValue('--shape-a').trim()};--shape-c:${cs.getPropertyValue('--shape-c').trim()};}`;
  clone.querySelector('defs').appendChild(style);

  const bgR=document.createElementNS('http://www.w3.org/2000/svg','rect');
  bgR.setAttribute('x',bb.x-pad); bgR.setAttribute('y',bb.y-pad);
  bgR.setAttribute('width',bb.width+pad*2); bgR.setAttribute('height',bb.height+pad*2);
  bgR.setAttribute('fill',bg);
  clone.insertBefore(bgR,clone.querySelector('defs').nextSibling);

  const svgStr=new XMLSerializer().serializeToString(clone);
  const url=URL.createObjectURL(new Blob([svgStr],{type:'image/svg+xml'}));
  const img=new Image();
  img.onload=()=>{
    const c=document.createElement('canvas'); c.width=W; c.height=H;
    const ctx=c.getContext('2d');
    ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);
    ctx.drawImage(img,0,0);
    URL.revokeObjectURL(url);
    c.toBlob(pb=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(pb); a.download='diagram.png'; a.click(); showToast('PNG exported @2x'); },'image/png');
  };
  img.src=url;
}

function blob(name,content,type) {
  const b=new Blob([content],{type});
  const u=URL.createObjectURL(b);
  const a=document.createElement('a'); a.href=u; a.download=name; a.click();
  URL.revokeObjectURL(u);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPLITTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(() => {
  const sp=document.getElementById('splitter');
  const pane=document.getElementById('editorPane');
  let dr=false;
  sp.addEventListener('mousedown',()=>{dr=true;sp.classList.add('active');});
  document.addEventListener('mouseup',()=>{dr=false;sp.classList.remove('active');});
  document.addEventListener('mousemove',e=>{
    if(!dr)return;
    const p=Math.max(15,Math.min(60,(e.clientX/window.innerWidth)*100));
    pane.style.width=p+'%';
  });
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EDITOR TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchEdTab(t) {
  document.querySelectorAll('.editor-tab').forEach((el,i)=>el.classList.toggle('active',(i===0)===(t==='json')));
  document.getElementById('monaco-editor').style.display=t==='json'?'flex':'none';
  document.getElementById('helpTab').style.display=t==='help'?'flex':'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg) {
  const t=document.getElementById('toast'); t.textContent=msg;
  t.classList.add('show'); clearTimeout(window._tt);
  window._tt=setTimeout(()=>t.classList.remove('show'),2000);
}
</script>
</body>
</html>
