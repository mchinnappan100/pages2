
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hub-Spoke Diagram Editor</title>
  <link rel="icon" type="image/x-icon" href="https://mohan-chinnappan-n5.github.io/dfv/img/mc_favIcon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.51.0/min/vs/loader.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    /* ‚îÄ‚îÄ Theme tokens ‚îÄ‚îÄ */
    :root {
      --bg:            #0a0c14;
      --bg2:           #111320;
      --bg3:           #1a1d2e;
      --border:        #252840;
      --text:          #e4e6f0;
      --text-muted:    #6b7096;
      --accent:        #5b6ef5;
      --accent2:       #8b5cf6;
      --accent-glow:   rgba(91,110,245,0.25);
      --node-fill:     #1a1d2e;
      --node-stroke:   #5b6ef5;
      --node-hover:    #22263d;
      --connector:     #2e3260;
      --connector-hi:  #5b6ef5;
      --center-fill:   #5b6ef5;
      --center-text:   #ffffff;
      --node-text:     #c8ccee;
      --shadow:        rgba(0,0,0,0.6);
      --header-bg:     rgba(10,12,20,0.92);
    }

    [data-theme="arctic"] {
      --bg:            #f0f4ff;
      --bg2:           #e4eaff;
      --bg3:           #d8e0ff;
      --border:        #c0caf5;
      --text:          #1a1d3a;
      --text-muted:    #6b7096;
      --accent:        #4f5ef0;
      --accent2:       #7c3aed;
      --accent-glow:   rgba(79,94,240,0.15);
      --node-fill:     #ffffff;
      --node-stroke:   #4f5ef0;
      --node-hover:    #eef0ff;
      --connector:     #a5b4fc;
      --connector-hi:  #4f5ef0;
      --center-fill:   #4f5ef0;
      --center-text:   #ffffff;
      --node-text:     #1a1d3a;
      --shadow:        rgba(0,0,50,0.1);
      --header-bg:     rgba(240,244,255,0.95);
    }

    [data-theme="ember"] {
      --bg:            #100a06;
      --bg2:           #1a100a;
      --bg3:           #241510;
      --border:        #3a2018;
      --text:          #f5e0c8;
      --text-muted:    #8a6050;
      --accent:        #f0722a;
      --accent2:       #e84040;
      --accent-glow:   rgba(240,114,42,0.25);
      --node-fill:     #1f130b;
      --node-stroke:   #f0722a;
      --node-hover:    #2a1a0e;
      --connector:     #4a2810;
      --connector-hi:  #f0722a;
      --center-fill:   #f0722a;
      --center-text:   #100a06;
      --node-text:     #f5d0a0;
      --shadow:        rgba(0,0,0,0.7);
      --header-bg:     rgba(16,10,6,0.95);
    }

    [data-theme="forest"] {
      --bg:            #080e0a;
      --bg2:           #0d1610;
      --bg3:           #121f15;
      --border:        #1e3020;
      --text:          #c8e8cc;
      --text-muted:    #5a7060;
      --accent:        #3ecf6c;
      --accent2:       #22c55e;
      --accent-glow:   rgba(62,207,108,0.2);
      --node-fill:     #0f1f12;
      --node-stroke:   #3ecf6c;
      --node-hover:    #162918;
      --connector:     #1e4024;
      --connector-hi:  #3ecf6c;
      --center-fill:   #3ecf6c;
      --center-text:   #080e0a;
      --node-text:     #a0dca8;
      --shadow:        rgba(0,0,0,0.7);
      --header-bg:     rgba(8,14,10,0.95);
    }

    [data-theme="rose"] {
      --bg:            #fdf2f8;
      --bg2:           #fce7f3;
      --bg3:           #fbcfe8;
      --border:        #f9a8d4;
      --text:          #4a0d2e;
      --text-muted:    #9d6080;
      --accent:        #db2777;
      --accent2:       #9333ea;
      --accent-glow:   rgba(219,39,119,0.15);
      --node-fill:     #fff5f9;
      --node-stroke:   #db2777;
      --node-hover:    #fce7f3;
      --connector:     #f9a8d4;
      --connector-hi:  #db2777;
      --center-fill:   #db2777;
      --center-text:   #ffffff;
      --node-text:     #4a0d2e;
      --shadow:        rgba(219,39,119,0.1);
      --header-bg:     rgba(253,242,248,0.95);
    }

    html, body { height: 100%; font-family: 'DM Sans', sans-serif; }

    body {
      background: var(--bg);
      color: var(--text);
      transition: background 0.4s, color 0.4s;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--header-bg);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .header-inner {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      max-width: 100%;
    }

    .logo {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 17px;
      letter-spacing: -0.3px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      white-space: nowrap;
    }

    .spacer { flex: 1; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: 'DM Sans', sans-serif;
      font-size: 12.5px;
      font-weight: 500;
      padding: 7px 14px;
      border-radius: 8px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      background: var(--bg3);
      border-color: var(--border);
      color: var(--text);
    }

    .btn:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }

    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .btn-primary:hover { opacity: 0.85; color: #fff; }

    .btn svg { width: 14px; height: 14px; flex-shrink: 0; }

    .theme-select {
      font-family: 'DM Sans', sans-serif;
      font-size: 12.5px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 10px;
      color: var(--text);
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
    }
    .theme-select:hover { border-color: var(--accent); }
    .theme-select option { background: var(--bg3); }

    .divider-v {
      width: 1px;
      height: 22px;
      background: var(--border);
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .layout {
      display: flex;
      height: calc(100vh - 53px);
    }

    .editor-pane {
      display: flex;
      flex-direction: column;
      min-width: 240px;
      max-width: 60%;
      width: 38%;
      background: var(--bg2);
      border-right: 1px solid var(--border);
      transition: width 0.1s;
    }

    .editor-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      flex-shrink: 0;
    }

    .editor-tab {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      padding: 8px 16px;
      cursor: pointer;
      border-right: 1px solid var(--border);
      color: var(--text-muted);
      transition: color 0.2s, background 0.2s;
      user-select: none;
    }

    .editor-tab.active {
      color: var(--accent);
      background: var(--bg2);
      border-bottom: 2px solid var(--accent);
    }

    .editor-tab:hover:not(.active) { color: var(--text); }

    #monaco-editor { flex: 1; overflow: hidden; }

    /* ‚îÄ‚îÄ Splitter ‚îÄ‚îÄ */
    .splitter {
      width: 5px;
      background: var(--border);
      cursor: col-resize;
      transition: background 0.2s;
      flex-shrink: 0;
      position: relative;
    }

    .splitter:hover, .splitter.active { background: var(--accent); }
    .splitter::after {
      content: '';
      position: absolute;
      inset: 0 -4px;
    }

    /* ‚îÄ‚îÄ Canvas ‚îÄ‚îÄ */
    .canvas-pane {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: var(--bg);
    }

    .canvas-bg-grid {
      position: absolute;
      inset: 0;
      background-image: 
        radial-gradient(circle, var(--border) 1px, transparent 1px);
      background-size: 28px 28px;
      opacity: 0.5;
      pointer-events: none;
    }

    #diagram-svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      cursor: default;
      user-select: none;
    }

    /* ‚îÄ‚îÄ Canvas toolbar ‚îÄ‚îÄ */
    .canvas-toolbar {
      position: absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 6px 10px;
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 32px var(--shadow);
      z-index: 10;
    }

    .canvas-btn {
      font-size: 11px;
      font-family: 'DM Mono', monospace;
      background: none;
      border: 1px solid transparent;
      border-radius: 7px;
      padding: 5px 10px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.18s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .canvas-btn:hover { border-color: var(--border); color: var(--text); background: var(--bg3); }
    .canvas-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
    .canvas-btn svg { width: 13px; height: 13px; }

    .canvas-divider { width: 1px; height: 18px; background: var(--border); margin: 0 2px; }

    /* ‚îÄ‚îÄ Zoom info ‚îÄ‚îÄ */
    .zoom-info {
      position: absolute;
      top: 14px;
      right: 14px;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg2);
      border: 1px solid var(--border);
      padding: 4px 10px;
      border-radius: 6px;
    }

    /* ‚îÄ‚îÄ SVG node styles (inlined for export) ‚îÄ‚îÄ */
    .node-rect {
      stroke-width: 1.5;
      rx: 10;
      transition: all 0.2s;
    }

    .connector-path {
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
    }

    /* ‚îÄ‚îÄ Edge handle (control point) ‚îÄ‚îÄ */
    .edge-handle {
      cursor: move;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .edge-handle:hover, .edge-handle.visible { opacity: 1; }

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--bg3);
      border: 1px solid var(--accent);
      color: var(--text);
      font-size: 12px;
      font-family: 'DM Mono', monospace;
      padding: 8px 18px;
      border-radius: 8px;
      opacity: 0;
      transition: all 0.3s;
      pointer-events: none;
      z-index: 999;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ‚îÄ‚îÄ Node detail panel ‚îÄ‚îÄ */
    .detail-panel {
      position: absolute;
      top: 14px;
      left: 14px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      min-width: 180px;
      box-shadow: 0 8px 24px var(--shadow);
      display: none;
      z-index: 20;
    }

    .detail-panel.visible { display: block; }

    .detail-title {
      font-family: 'Syne', sans-serif;
      font-size: 11px;
      font-weight: 700;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 10px;
    }

    .detail-input {
      width: 100%;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 6px 10px;
      font-size: 13px;
      font-family: 'DM Sans', sans-serif;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s;
    }
    .detail-input:focus { border-color: var(--accent); }

    .detail-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .detail-label {
      font-size: 11px;
      color: var(--text-muted);
      min-width: 50px;
      font-family: 'DM Mono', monospace;
    }

    .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .close-btn:hover { background: var(--bg3); color: var(--text); }
  </style>
</head>
<body data-theme="cosmic">

<header>
  <div class="header-inner">
    <div class="logo">‚¨° HubSpoke</div>

    <div class="divider-v"></div>

    <button class="btn btn-primary" onclick="addNode('left')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
      Left Node
    </button>

    <button class="btn btn-primary" onclick="addNode('right')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
      Right Node
    </button>

    <div class="divider-v"></div>

    <button class="btn" onclick="uploadFile()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 16a4 4 0 01-.88-7.9A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
      Import
    </button>

    <button class="btn" onclick="downloadJSON()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
      JSON
    </button>

    <button class="btn" onclick="exportSVG()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
      SVG
    </button>

    <button class="btn" onclick="exportPNG()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
      PNG
    </button>

    <div class="divider-v"></div>

    <select class="theme-select" onchange="setTheme(this.value)" id="themeSelect">
      <option value="cosmic">üåå Cosmic</option>
      <option value="arctic">üèî Arctic</option>
      <option value="ember">üî• Ember</option>
      <option value="forest">üåø Forest</option>
      <option value="rose">üå∏ Rose</option>
    </select>
  </div>
</header>

<div class="layout">
  <!-- Editor pane -->
  <div class="editor-pane" id="editorPane">
    <div class="editor-tabs">
      <div class="editor-tab active" onclick="switchTab('json')">diagram.json</div>
      <div class="editor-tab" onclick="switchTab('help')">help</div>
    </div>
    <div id="monaco-editor" style="flex:1;overflow:hidden;"></div>
    <div id="help-tab" style="display:none;flex:1;overflow:auto;padding:20px;font-family:'DM Mono',monospace;font-size:12px;color:var(--text-muted);line-height:1.8;">
      <div style="color:var(--accent);font-weight:700;margin-bottom:12px;font-family:'Syne',sans-serif;">KEYBOARD SHORTCUTS</div>
      <div><span style="color:var(--text)">Drag node</span> ‚Äî move nodes freely</div>
      <div><span style="color:var(--text)">Drag ‚óÜ handle</span> ‚Äî bend connector curves</div>
      <div><span style="color:var(--text)">Double-click node</span> ‚Äî rename inline</div>
      <div><span style="color:var(--text)">Ctrl+scroll</span> ‚Äî zoom canvas</div>
      <div><span style="color:var(--text)">Space+drag</span> ‚Äî pan canvas</div>
      <div><span style="color:var(--text)">Delete</span> ‚Äî remove selected node</div>
      <div style="margin-top:16px;color:var(--accent);font-weight:700;font-family:'Syne',sans-serif;">JSON SCHEMA</div>
      <div style="margin-top:8px;background:var(--bg3);padding:12px;border-radius:8px;border:1px solid var(--border);">
<pre>{
  "center": "string",
  "left": ["label", ...],
  "right": ["label", ...],
  "style": {
    "centerRadius": 80,
    "nodeWidth": 160,
    "nodeHeight": 48,
    "leftOffset": 320,
    "rightOffset": 320,
    "verticalSpread": 110
  }
}</pre>
      </div>
    </div>
  </div>

  <div class="splitter" id="splitter"></div>

  <!-- Canvas -->
  <div class="canvas-pane" id="canvasPane">
    <div class="canvas-bg-grid"></div>

    <svg id="diagram-svg" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
          <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
          <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="4" stdDeviation="8" flood-color="rgba(0,0,0,0.4)"/>
        </filter>
        <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
          <path d="M0,0 L0,6 L8,3 z" fill="var(--connector)"/>
        </marker>
      </defs>
      <g id="canvas-group"></g>
    </svg>

    <div class="zoom-info" id="zoomInfo">100%</div>

    <!-- Node detail panel -->
    <div class="detail-panel" id="detailPanel">
      <div class="detail-title">Node Properties</div>
      <button class="close-btn" onclick="closeDetailPanel()">√ó</button>
      <input class="detail-input" id="detailLabel" placeholder="Label" oninput="updateSelectedLabel(this.value)">
      <div class="detail-row">
        <span class="detail-label">color</span>
        <input type="color" id="detailColor" oninput="updateSelectedColor(this.value)" style="border:none;background:none;cursor:pointer;width:32px;height:24px;">
      </div>
      <div class="detail-row" style="margin-top:12px;">
        <button class="btn" style="flex:1;justify-content:center;" onclick="deleteSelectedNode()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6l-1 14H6L5 6M10 11v6M14 11v6M9 6V4h6v2"/></svg>
          Delete
        </button>
      </div>
    </div>

    <!-- Canvas toolbar -->
    <div class="canvas-toolbar">
      <button class="canvas-btn active" id="modeSelect" onclick="setMode('select')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3l14 9-7 1-4 7z"/></svg>
        Select
      </button>
      <button class="canvas-btn" id="modePan" onclick="setMode('pan')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M12 12h.01"/></svg>
        Pan
      </button>
      <div class="canvas-divider"></div>
      <button class="canvas-btn" onclick="zoomIn()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35M8 11h6M11 8v6"/></svg>
        Zoom+
      </button>
      <button class="canvas-btn" onclick="zoomOut()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35M8 11h6"/></svg>
        Zoom-
      </button>
      <button class="canvas-btn" onclick="resetView()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1018 0A9 9 0 003 12zM12 8v4l3 3"/></svg>
        Reset
      </button>
      <div class="canvas-divider"></div>
      <button class="canvas-btn" onclick="toggleEdgeHandles()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3"/></svg>
        Handles
      </button>
      <button class="canvas-btn" onclick="autoLayout()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v4H3zM3 10h12v4H3zM3 17h8v4H3z"/></svg>
        Layout
      </button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
require.config({ paths: { vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.51.0/min/vs" }});

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const defaultData = {
  center: "Product",
  left: ["Auth Service", "Billing", "Analytics", "Support"],
  right: ["Inventory", "CRM", "Marketing", "Payments", "Notifications"],
  style: {
    centerRadius: 80,
    nodeWidth: 160,
    nodeHeight: 46,
    leftOffset: 300,
    rightOffset: 300,
    verticalSpread: 100
  }
};

let diagram = JSON.parse(JSON.stringify(defaultData));

// Node state: { id, label, side, x, y, color, baseX, baseY }
let nodes = [];
// Edge state: { id, fromNode, toNode, cpX, cpY } (cpX/cpY = control point offset)
let edges = [];
let nodeIdCounter = 0;
let edgeIdCounter = 0;

// Canvas transform
let viewX = 0, viewY = 0, viewScale = 1;

// Drag state
let dragState = null; // { type: 'node'|'edge'|'pan', ... }
let mode = 'select'; // 'select' | 'pan'
let showHandles = false;
let selectedNodeId = null;
let spaceDown = false;

// Monaco
let editor;

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
  initMonaco();
  initCanvas();
  buildFromData(diagram);
  applyTheme('cosmic');
  document.getElementById('themeSelect').value = 'cosmic';
});

function initMonaco() {
  require(["vs/editor/editor.main"], () => {
    editor = monaco.editor.create(document.getElementById("monaco-editor"), {
      value: JSON.stringify(defaultData, null, 2),
      language: "json",
      theme: "vs-dark",
      automaticLayout: true,
      minimap: { enabled: false },
      fontSize: 13,
      fontFamily: "'DM Mono', monospace",
      lineNumbers: "on",
      scrollBeyondLastLine: false,
      smoothScrolling: true,
      roundedSelection: true,
      padding: { top: 12 }
    });

    editor.onDidChangeModelContent(() => {
      clearTimeout(window.renderTimer);
      window.renderTimer = setTimeout(loadFromEditor, 400);
    });
  });
}

// ‚îÄ‚îÄ Data ‚Üí Node/Edge model ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildFromData(data) {
  nodes = [];
  edges = [];
  nodeIdCounter = 0;
  edgeIdCounter = 0;

  const {
    center = "Center",
    left = [],
    right = [],
    style = {}
  } = data;

  const {
    centerRadius = 80,
    nodeWidth  = 160,
    nodeHeight = 46,
    leftOffset  = 300,
    rightOffset = 300,
    verticalSpread = 100
  } = style;

  const cx = 500, cy = 400;

  // Center node (special)
  const centerNode = {
    id: nodeIdCounter++,
    label: center,
    side: 'center',
    x: cx, y: cy,
    baseX: cx, baseY: cy,
    r: centerRadius,
    color: null
  };
  nodes.push(centerNode);

  // Left nodes
  left.forEach((label, i) => {
    const y = cy + (i - (left.length - 1) / 2) * verticalSpread;
    const x = cx - leftOffset;
    const n = { id: nodeIdCounter++, label, side: 'left', x, y, baseX: x, baseY: y, width: nodeWidth, height: nodeHeight, color: null };
    nodes.push(n);
    edges.push({ id: edgeIdCounter++, fromId: centerNode.id, toId: n.id, cpOffX: 0, cpOffY: 0 });
  });

  // Right nodes
  right.forEach((label, i) => {
    const y = cy + (i - (right.length - 1) / 2) * verticalSpread;
    const x = cx + rightOffset;
    const n = { id: nodeIdCounter++, label, side: 'right', x, y, baseX: x, baseY: y, width: nodeWidth, height: nodeHeight, color: null };
    nodes.push(n);
    edges.push({ id: edgeIdCounter++, fromId: centerNode.id, toId: n.id, cpOffX: 0, cpOffY: 0 });
  });

  render();
}

function loadFromEditor() {
  if (!editor) return;
  try {
    const d = JSON.parse(editor.getValue());
    diagram = d;
    buildFromData(d);
  } catch(e) {
    // invalid json
  }
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  const g = document.getElementById('canvas-group');
  g.innerHTML = '';
  g.setAttribute('transform', `translate(${viewX},${viewY}) scale(${viewScale})`);

  const style = getComputedStyle(document.body);
  const accentColor    = style.getPropertyValue('--accent').trim();
  const nodeStroke     = style.getPropertyValue('--node-stroke').trim();
  const nodeFill       = style.getPropertyValue('--node-fill').trim();
  const connectorColor = style.getPropertyValue('--connector').trim();
  const connectorHi    = style.getPropertyValue('--connector-hi').trim();
  const nodeTextColor  = style.getPropertyValue('--node-text').trim();
  const centerTextColor= style.getPropertyValue('--center-text').trim();
  const centerFill     = style.getPropertyValue('--center-fill').trim();

  // Draw edges first
  edges.forEach(edge => {
    const fromNode = nodes.find(n => n.id === edge.fromId);
    const toNode   = nodes.find(n => n.id === edge.toId);
    if (!fromNode || !toNode) return;

    const {x1, y1, x2, y2} = getEdgeEndpoints(fromNode, toNode);

    // Control point = midpoint + offset
    const midX = (x1 + x2) / 2 + edge.cpOffX;
    const midY = (y1 + y2) / 2 + edge.cpOffY;

    // Quadratic bezier via control point
    const pathD = `M${x1},${y1} Q${midX},${midY} ${x2},${y2}`;

    const selected = selectedNodeId !== null && 
      (fromNode.id === selectedNodeId || toNode.id === selectedNodeId);

    const path = createSVGEl('path', {
      d: pathD,
      fill: 'none',
      stroke: selected ? connectorHi : connectorColor,
      'stroke-width': selected ? 2.5 : 1.8,
      'stroke-linecap': 'round',
      'data-edge-id': edge.id,
      class: 'connector-path'
    });
    g.appendChild(path);

    // Edge handle (control point diamond)
    if (showHandles) {
      const handle = createSVGEl('path', {
        d: `M${midX},${midY-7} L${midX+7},${midY} L${midX},${midY+7} L${midX-7},${midY} Z`,
        fill: accentColor,
        stroke: 'white',
        'stroke-width': 1.5,
        class: 'edge-handle',
        'data-edge-id': edge.id,
        style: 'cursor:move;opacity:0.9;'
      });
      handle.addEventListener('mousedown', e => startEdgeDrag(e, edge.id));
      handle.addEventListener('touchstart', e => startEdgeDrag(e, edge.id), { passive: false });
      g.appendChild(handle);
    }
  });

  // Draw nodes
  nodes.forEach(node => {
    const isSelected = node.id === selectedNodeId;
    const fill = node.color || (node.side === 'center' ? centerFill : nodeFill);
    const stroke = isSelected ? accentColor : nodeStroke;
    const textColor = node.side === 'center' ? centerTextColor : nodeTextColor;

    const grp = createSVGEl('g', {
      class: 'node-group',
      'data-node-id': node.id,
      style: 'cursor:grab;'
    });

    if (node.side === 'center') {
      // Circle
      const circle = createSVGEl('circle', {
        cx: node.x, cy: node.y,
        r: node.r || 80,
        fill,
        stroke,
        'stroke-width': isSelected ? 3 : 2,
        style: isSelected ? 'filter:url(#glow)' : ''
      });
      grp.appendChild(circle);

      const text = createSVGEl('text', {
        x: node.x, y: node.y,
        fill: textColor,
        'text-anchor': 'middle',
        'dominant-baseline': 'middle',
        'font-size': 20,
        'font-weight': 700,
        'font-family': "'Syne', sans-serif",
        'pointer-events': 'none'
      });
      text.textContent = node.label;
      grp.appendChild(text);
    } else {
      const hw = (node.width || 160) / 2;
      const hh = (node.height || 46) / 2;

      const rect = createSVGEl('rect', {
        x: node.x - hw, y: node.y - hh,
        width: node.width || 160,
        height: node.height || 46,
        rx: 10, ry: 10,
        fill,
        stroke,
        'stroke-width': isSelected ? 2.5 : 1.5,
        style: isSelected ? 'filter:url(#glow)' : ''
      });
      grp.appendChild(rect);

      const text = createSVGEl('text', {
        x: node.x, y: node.y,
        fill: textColor,
        'text-anchor': 'middle',
        'dominant-baseline': 'middle',
        'font-size': 14,
        'font-weight': 500,
        'font-family': "'DM Sans', sans-serif",
        'pointer-events': 'none'
      });
      text.textContent = node.label;
      grp.appendChild(text);
    }

    grp.addEventListener('mousedown', e => onNodeMouseDown(e, node.id));
    grp.addEventListener('touchstart', e => onNodeMouseDown(e, node.id), { passive: false });
    grp.addEventListener('dblclick', () => startInlineRename(node.id));

    g.appendChild(grp);
  });
}

function getEdgeEndpoints(fromNode, toNode) {
  // From center node to spoke node
  let x1, y1, x2, y2;

  if (fromNode.side === 'center') {
    const r = fromNode.r || 80;
    const dx = toNode.x - fromNode.x;
    const dy = toNode.y - fromNode.y;
    const dist = Math.sqrt(dx*dx + dy*dy) || 1;
    x1 = fromNode.x + dx/dist * r;
    y1 = fromNode.y + dy/dist * r;
  } else {
    x1 = fromNode.x; y1 = fromNode.y;
  }

  if (toNode.side === 'center') {
    const r = toNode.r || 80;
    const dx = fromNode.x - toNode.x;
    const dy = fromNode.y - toNode.y;
    const dist = Math.sqrt(dx*dx + dy*dy) || 1;
    x2 = toNode.x + dx/dist * r;
    y2 = toNode.y + dy/dist * r;
  } else {
    // Connect to nearest side of rectangle
    const hw = (toNode.width || 160) / 2;
    const side = toNode.x > fromNode.x ? -hw : hw;
    x2 = toNode.x + side;
    y2 = toNode.y;
  }

  return { x1, y1, x2, y2 };
}

function createSVGEl(tag, attrs) {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for (const [k, v] of Object.entries(attrs)) {
    el.setAttribute(k, v);
  }
  return el;
}

// ‚îÄ‚îÄ Canvas interactions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initCanvas() {
  const svg = document.getElementById('diagram-svg');

  svg.addEventListener('mousedown', onCanvasMouseDown);
  svg.addEventListener('touchstart', onCanvasMouseDown, { passive: false });
  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('touchmove', onMouseMove, { passive: false });
  document.addEventListener('mouseup', onMouseUp);
  document.addEventListener('touchend', onMouseUp);

  svg.addEventListener('wheel', onWheel, { passive: false });

  document.addEventListener('keydown', e => {
    if (e.code === 'Space' && !e.target.matches('input,textarea')) {
      spaceDown = true;
      svg.style.cursor = 'grab';
    }
    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedNodeId !== null && !e.target.matches('input,textarea')) {
      deleteSelectedNode();
    }
  });

  document.addEventListener('keyup', e => {
    if (e.code === 'Space') {
      spaceDown = false;
      svg.style.cursor = 'default';
    }
  });
}

function getSVGPoint(e) {
  const svg = document.getElementById('diagram-svg');
  const rect = svg.getBoundingClientRect();
  const evt = e.touches ? e.touches[0] : e;
  const cx = evt.clientX - rect.left;
  const cy = evt.clientY - rect.top;
  // Convert to canvas space
  return {
    x: (cx - viewX) / viewScale,
    y: (cy - viewY) / viewScale,
    rawX: cx,
    rawY: cy
  };
}

function onCanvasMouseDown(e) {
  if (e.target === document.getElementById('diagram-svg') || 
      e.target === document.getElementById('canvas-group')) {
    if (mode === 'pan' || spaceDown) {
      const evt = e.touches ? e.touches[0] : e;
      dragState = { type: 'pan', startX: evt.clientX, startY: evt.clientY, startVX: viewX, startVY: viewY };
    } else {
      // Deselect
      selectedNodeId = null;
      closeDetailPanel();
      render();
    }
  }
}

function onNodeMouseDown(e, nodeId) {
  if (e.button === 2) return;
  e.preventDefault();
  e.stopPropagation();

  if (mode === 'pan' || spaceDown) {
    const evt = e.touches ? e.touches[0] : e;
    dragState = { type: 'pan', startX: evt.clientX, startY: evt.clientY, startVX: viewX, startVY: viewY };
    return;
  }

  const node = nodes.find(n => n.id === nodeId);
  if (!node) return;

  selectedNodeId = nodeId;
  const pt = getSVGPoint(e);
  dragState = {
    type: 'node',
    nodeId,
    startX: pt.x, startY: pt.y,
    origX: node.x, origY: node.y
  };

  // Update detail panel
  showDetailPanel(node);
  render();
}

function startEdgeDrag(e, edgeId) {
  e.preventDefault();
  e.stopPropagation();
  const edge = edges.find(ed => ed.id === edgeId);
  if (!edge) return;

  const pt = getSVGPoint(e);
  dragState = {
    type: 'edge',
    edgeId,
    startX: pt.x, startY: pt.y,
    origCpX: edge.cpOffX,
    origCpY: edge.cpOffY
  };
}

function onMouseMove(e) {
  if (!dragState) return;
  e.preventDefault();

  if (dragState.type === 'pan') {
    const evt = e.touches ? e.touches[0] : e;
    viewX = dragState.startVX + (evt.clientX - dragState.startX);
    viewY = dragState.startVY + (evt.clientY - dragState.startY);
    document.getElementById('canvas-group').setAttribute('transform', 
      `translate(${viewX},${viewY}) scale(${viewScale})`);
    return;
  }

  if (dragState.type === 'node') {
    const pt = getSVGPoint(e);
    const dx = pt.x - dragState.startX;
    const dy = pt.y - dragState.startY;
    const node = nodes.find(n => n.id === dragState.nodeId);
    if (node) {
      node.x = dragState.origX + dx;
      node.y = dragState.origY + dy;
      render();
    }
    return;
  }

  if (dragState.type === 'edge') {
    const pt = getSVGPoint(e);
    const dx = pt.x - dragState.startX;
    const dy = pt.y - dragState.startY;
    const edge = edges.find(ed => ed.id === dragState.edgeId);
    if (edge) {
      edge.cpOffX = dragState.origCpX + dx;
      edge.cpOffY = dragState.origCpY + dy;
      render();
    }
  }
}

function onMouseUp() {
  if (dragState) {
    syncEditorFromState();
  }
  dragState = null;
}

function onWheel(e) {
  e.preventDefault();
  const rect = document.getElementById('diagram-svg').getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  const delta = e.deltaY > 0 ? 0.9 : 1.1;
  const newScale = Math.max(0.15, Math.min(4, viewScale * delta));

  viewX = mouseX - (mouseX - viewX) * (newScale / viewScale);
  viewY = mouseY - (mouseY - viewY) * (newScale / viewScale);
  viewScale = newScale;

  document.getElementById('canvas-group').setAttribute('transform',
    `translate(${viewX},${viewY}) scale(${viewScale})`);
  document.getElementById('zoomInfo').textContent = Math.round(viewScale * 100) + '%';
}

// ‚îÄ‚îÄ Node operations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addNode(side) {
  const center = nodes.find(n => n.side === 'center');
  if (!center) return;

  const sideNodes = nodes.filter(n => n.side === side);
  const style = diagram.style || {};
  const offset = side === 'left' ? -(style.leftOffset || 300) : (style.rightOffset || 300);
  const vSpread = style.verticalSpread || 100;
  const cy = center.y;

  const newY = cy + sideNodes.length * vSpread - ((sideNodes.length) / 2) * vSpread;
  const newX = center.x + offset;

  const newNode = {
    id: nodeIdCounter++,
    label: side === 'left' ? 'New Left' : 'New Right',
    side,
    x: newX,
    y: newY,
    baseX: newX,
    baseY: newY,
    width: style.nodeWidth || 160,
    height: style.nodeHeight || 46,
    color: null
  };
  nodes.push(newNode);
  edges.push({ id: edgeIdCounter++, fromId: center.id, toId: newNode.id, cpOffX: 0, cpOffY: 0 });

  selectedNodeId = newNode.id;
  showDetailPanel(newNode);
  render();
  syncEditorFromState();
  showToast(`Added ${side} node`);
}

function deleteSelectedNode() {
  if (selectedNodeId === null) return;
  const node = nodes.find(n => n.id === selectedNodeId);
  if (!node || node.side === 'center') {
    showToast('Cannot delete center node');
    return;
  }
  nodes = nodes.filter(n => n.id !== selectedNodeId);
  edges = edges.filter(e => e.fromId !== selectedNodeId && e.toId !== selectedNodeId);
  selectedNodeId = null;
  closeDetailPanel();
  render();
  syncEditorFromState();
  showToast('Node deleted');
}

function startInlineRename(nodeId) {
  const node = nodes.find(n => n.id === nodeId);
  if (!node) return;
  selectedNodeId = nodeId;
  showDetailPanel(node);
  document.getElementById('detailLabel').focus();
  document.getElementById('detailLabel').select();
}

function updateSelectedLabel(val) {
  if (selectedNodeId === null) return;
  const node = nodes.find(n => n.id === selectedNodeId);
  if (node) {
    node.label = val;
    render();
  }
  clearTimeout(window.syncTimer);
  window.syncTimer = setTimeout(() => syncEditorFromState(), 600);
}

function updateSelectedColor(val) {
  if (selectedNodeId === null) return;
  const node = nodes.find(n => n.id === selectedNodeId);
  if (node) {
    node.color = val;
    render();
  }
}

function showDetailPanel(node) {
  const panel = document.getElementById('detailPanel');
  panel.classList.add('visible');
  document.getElementById('detailLabel').value = node.label;
  document.getElementById('detailColor').value = node.color || '#5b6ef5';
}

function closeDetailPanel() {
  document.getElementById('detailPanel').classList.remove('visible');
}

// ‚îÄ‚îÄ Sync editor ‚Üí state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function syncEditorFromState() {
  if (!editor) return;
  const centerNode = nodes.find(n => n.side === 'center');
  const leftNodes  = nodes.filter(n => n.side === 'left');
  const rightNodes = nodes.filter(n => n.side === 'right');

  const out = {
    center: centerNode ? centerNode.label : 'Center',
    left:   leftNodes.map(n => n.label),
    right:  rightNodes.map(n => n.label),
    style:  diagram.style || defaultData.style
  };

  const str = JSON.stringify(out, null, 2);
  if (str !== editor.getValue()) {
    editor.setValue(str);
  }
}

// ‚îÄ‚îÄ Canvas controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setMode(m) {
  mode = m;
  document.getElementById('modeSelect').classList.toggle('active', m === 'select');
  document.getElementById('modePan').classList.toggle('active', m === 'pan');
  document.getElementById('diagram-svg').style.cursor = m === 'pan' ? 'grab' : 'default';
}

function zoomIn()  { applyZoom(1.25); }
function zoomOut() { applyZoom(0.8); }

function applyZoom(factor) {
  const pane = document.getElementById('canvasPane');
  const cx = pane.clientWidth / 2;
  const cy = pane.clientHeight / 2;
  const newScale = Math.max(0.15, Math.min(4, viewScale * factor));
  viewX = cx - (cx - viewX) * (newScale / viewScale);
  viewY = cy - (cy - viewY) * (newScale / viewScale);
  viewScale = newScale;
  document.getElementById('canvas-group').setAttribute('transform',
    `translate(${viewX},${viewY}) scale(${viewScale})`);
  document.getElementById('zoomInfo').textContent = Math.round(viewScale * 100) + '%';
}

function resetView() {
  viewX = 0; viewY = 0; viewScale = 1;
  document.getElementById('canvas-group').setAttribute('transform', 'translate(0,0) scale(1)');
  document.getElementById('zoomInfo').textContent = '100%';
}

function toggleEdgeHandles() {
  showHandles = !showHandles;
  render();
  showToast(showHandles ? 'Edge handles ON' : 'Edge handles OFF');
}

function autoLayout() {
  const center = nodes.find(n => n.side === 'center');
  if (!center) return;
  const leftNodes  = nodes.filter(n => n.side === 'left');
  const rightNodes = nodes.filter(n => n.side === 'right');
  const style = diagram.style || defaultData.style;
  const vSpread = style.verticalSpread || 100;

  leftNodes.forEach((n, i) => {
    n.x = center.x - (style.leftOffset || 300);
    n.y = center.y + (i - (leftNodes.length - 1) / 2) * vSpread;
  });
  rightNodes.forEach((n, i) => {
    n.x = center.x + (style.rightOffset || 300);
    n.y = center.y + (i - (rightNodes.length - 1) / 2) * vSpread;
  });
  // Reset edge control points
  edges.forEach(e => { e.cpOffX = 0; e.cpOffY = 0; });

  render();
  syncEditorFromState();
  showToast('Layout reset');
}

// ‚îÄ‚îÄ Theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTheme(name) {
  applyTheme(name);
}

function applyTheme(name) {
  // Map our themes
  const themeMap = {
    cosmic:  'dark',
    arctic:  'arctic',
    ember:   'ember',
    forest:  'forest',
    rose:    'rose'
  };
  document.body.dataset.theme = themeMap[name] || name;

  if (editor) {
    editor.updateOptions({ theme: (name === 'arctic' || name === 'rose') ? 'vs' : 'vs-dark' });
  }

  // Re-render with new colors
  setTimeout(render, 50);
}

// ‚îÄ‚îÄ Splitter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(() => {
  const splitter = document.getElementById('splitter');
  const pane = document.getElementById('editorPane');
  let dragging = false;

  splitter.addEventListener('mousedown', () => { dragging = true; splitter.classList.add('active'); });
  document.addEventListener('mouseup', () => { dragging = false; splitter.classList.remove('active'); });
  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    const pct = Math.max(18, Math.min(65, (e.clientX / window.innerWidth) * 100));
    pane.style.width = pct + '%';
  });
})();

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  document.querySelectorAll('.editor-tab').forEach((t, i) => {
    t.classList.toggle('active', (i === 0) === (tab === 'json'));
  });
  document.getElementById('monaco-editor').style.display = tab === 'json' ? 'flex' : 'none';
  document.getElementById('help-tab').style.display = tab === 'help' ? 'flex' : 'none';
  document.getElementById('monaco-editor').style.flex = tab === 'json' ? '1' : '';
}

// ‚îÄ‚îÄ Import / Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function uploadFile() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const d = JSON.parse(reader.result);
        diagram = d;
        editor && editor.setValue(JSON.stringify(d, null, 2));
        buildFromData(d);
        showToast('Diagram loaded!');
      } catch { showToast('Invalid JSON file'); }
    };
    reader.readAsText(file);
  };
  input.click();
}

function downloadJSON() {
  const content = editor ? editor.getValue() : JSON.stringify(diagram, null, 2);
  downloadBlob('diagram.json', content, 'application/json');
  showToast('JSON downloaded');
}

function exportSVG() {
  // Build standalone SVG with inline styles
  const svg = document.getElementById('diagram-svg');
  const style = getComputedStyle(document.body);

  // Get bounding box of content
  const g = document.getElementById('canvas-group');
  const bbox = g.getBBox();
  const pad = 40;

  const w = bbox.width + pad * 2;
  const h = bbox.height + pad * 2;

  // Clone SVG with neutral transform
  const clone = svg.cloneNode(true);
  clone.setAttribute('width', w);
  clone.setAttribute('height', h);
  clone.setAttribute('viewBox', `${bbox.x - pad} ${bbox.y - pad} ${w} ${h}`);

  // Remove the viewX/Y transform from group
  const cloneG = clone.querySelector('#canvas-group');
  if (cloneG) cloneG.removeAttribute('transform');

  // Inline fonts
  const fontStyle = document.createElementNS('http://www.w3.org/2000/svg', 'style');
  fontStyle.textContent = `
    @import url('https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500&display=swap');
    text { font-family: 'DM Sans', sans-serif; }
  `;
  clone.querySelector('defs').appendChild(fontStyle);

  // Set background
  const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  bg.setAttribute('x', bbox.x - pad);
  bg.setAttribute('y', bbox.y - pad);
  bg.setAttribute('width', w);
  bg.setAttribute('height', h);
  bg.setAttribute('fill', style.getPropertyValue('--bg').trim());
  clone.insertBefore(bg, clone.firstChild.nextSibling);

  const serializer = new XMLSerializer();
  let svgStr = serializer.serializeToString(clone);

  // Remove edge handles from export
  svgStr = svgStr.replace(/<path[^>]*class="edge-handle"[^>]*\/>/g, '');

  downloadBlob('diagram.svg', svgStr, 'image/svg+xml');
  showToast('SVG exported');
}

async function exportPNG() {
  const svg = document.getElementById('diagram-svg');
  const g = document.getElementById('canvas-group');
  const bbox = g.getBBox();
  const pad = 40;
  const scale = 2;

  const w = (bbox.width + pad * 2) * scale;
  const h = (bbox.height + pad * 2) * scale;

  const style = getComputedStyle(document.body);
  const bgColor = style.getPropertyValue('--bg').trim();

  // Build SVG string
  const clone = svg.cloneNode(true);
  clone.setAttribute('width', w);
  clone.setAttribute('height', h);
  clone.setAttribute('viewBox', `${bbox.x - pad} ${bbox.y - pad} ${bbox.width + pad*2} ${bbox.height + pad*2}`);
  const cloneG = clone.querySelector('#canvas-group');
  if (cloneG) cloneG.removeAttribute('transform');

  // Remove handles
  clone.querySelectorAll('.edge-handle').forEach(el => el.remove());

  const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  bg.setAttribute('x', bbox.x - pad);
  bg.setAttribute('y', bbox.y - pad);
  bg.setAttribute('width', bbox.width + pad * 2);
  bg.setAttribute('height', bbox.height + pad * 2);
  bg.setAttribute('fill', bgColor);
  clone.insertBefore(bg, clone.firstChild.nextSibling);

  const svgStr = new XMLSerializer().serializeToString(clone);
  const blob = new Blob([svgStr], { type: 'image/svg+xml' });
  const url = URL.createObjectURL(blob);

  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, w, h);
    ctx.drawImage(img, 0, 0);
    URL.revokeObjectURL(url);

    canvas.toBlob(pngBlob => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(pngBlob);
      a.download = 'diagram.png';
      a.click();
      showToast('PNG exported @2x');
    }, 'image/png');
  };
  img.src = url;
}

function downloadBlob(filename, content, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(window.toastTimer);
  window.toastTimer = setTimeout(() => t.classList.remove('show'), 2000);
}
</script>
</body>
</html>
